<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Alarma</title>
    <!-- Tailwind CSS CDN para estilos rápidos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para iconos (papelera, toggle, plus, times) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Importa la fuente Inter para una estética moderna */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Establece la imagen de fondo y cúbrela en todo el viewport */
            background-image: url('https://i.imgur.com/iqIxn1N.jpeg');
            background-size: cover; /* Asegura que la imagen cubra todo el fondo */
            background-position: center; /* Centra la imagen de fondo */
            background-repeat: no-repeat; /* Evita que la imagen se repita */
            background-attachment: fixed; /* Mantiene el fondo fijo al hacer scroll */
            display: flex; /* Usa flexbox para centrar el contenido verticalmente */
            flex-direction: column; /* Organiza los elementos en columna */
            align-items: center; /* Centra horizontalmente */
            justify-content: flex-start; /* Alinea al inicio verticalmente (parte superior) */
            min-height: 100vh; /* Asegura que ocupe al menos el 100% del alto de la ventana */
            padding-top: 2rem; /* Espacio superior para el reloj */
            padding-bottom: 2rem; /* Espacio inferior */
            position: relative; /* Necesario para posicionar el display de alarma sonando */
        }
        /* Estilos para el display de la hora actual */
        #currentTime {
            font-size: 4.5rem; /* Enorme */
            font-weight: 800; /* Extra bold */
            background: linear-gradient(45deg, #6366f1, #a855f7); /* Degradado morado/púrpura */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem; /* Espacio debajo del reloj */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center; /* Centra el texto del reloj */
            width: 100%; /* Ocupa todo el ancho para centrarlo */
            max-width: 450px; /* Limita el ancho para que no se extienda demasiado */
        }
        /* Estilos para los inputs de texto y hora, y selects */
        input[type="time"], input[type="text"], select {
            padding: 0.75rem 1rem;
            border: 2px solid #cbd5e1; /* Borde gris claro */
            border-radius: 0.75rem; /* Bordes redondeados */
            font-size: 1.25rem; /* Tamaño de fuente más grande */
            text-align: center;
            width: 100%;
            background-color: #f8fafc; /* Fondo ligeramente diferente */
            color: #334155; /* Color de texto oscuro */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            -webkit-appearance: none; /* Eliminar estilos por defecto de select en algunos navegadores */
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); /* Flecha para select */
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        input[type="time"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #6366f1; /* Borde morado al enfocar */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Sombra de enfoque */
        }
        /* Estilos base para todos los botones */
        button {
            padding: 0.8rem 1.8rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%; /* Ancho completo en móvil */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        /* Botones principales (Establecer, Añadir) */
        .btn-primary {
            background: linear-gradient(45deg, #6366f1, #a855f7); /* Degradado morado/púrpura */
            color: #ffffff;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #4f46e5, #9333ea); /* Degradado más oscuro */
        }
        /* Botones secundarios (Borrar, Cancelar) */
        .btn-secondary {
            background-color: #ef4444; /* Rojo */
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #dc2626; /* Rojo más oscuro */
        }
        /* Action buttons in list (delete, toggle) */
        .btn-action {
            background-color: transparent;
            color: #475569;
            box-shadow: none;
            padding: 0.5rem;
            width: auto;
        }
        .btn-action:hover {
            color: #1e293b;
            transform: none;
            box-shadow: none;
        }
        .btn-delete:hover {
            color: #ef4444;
        }
        /* Estilos para la lista de alarmas */
        #alarmsList {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
            max-width: 450px; /* Limita el ancho para que no se extienda demasiado */
        }
        .alarm-item {
            background-color: rgba(255, 255, 255, 0.9); /* Fondo semi-transparente para cada item */
            border-radius: 1rem;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease;
            border-left: 6px solid #6366f1; /* Borde izquierdo para indicar activo */
        }
        .alarm-item.inactive {
            background-color: rgba(241, 245, 249, 0.9); /* Gris claro semi-transparente para inactivo */
            border-left-color: #94a3b8; /* Gris para inactivo */
            opacity: 0.7;
        }
        .alarm-item:hover {
            transform: translateY(-3px);
        }
        .alarm-info {
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        .alarm-time {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
        }
        .alarm-name {
            font-size: 1rem;
            color: #475569;
        }
        .alarm-details {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        .alarm-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        /* Estilos para el toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #6366f1;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #6366f1;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* Estilos para el formulario de añadir/editar alarma (directamente en la página) */
        #alarmInputForm {
            background-color: rgba(159, 184, 255, 0.9); /* Un azul claro semi-transparente */
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem; /* Espacio entre el botón de añadir y el formulario */
            width: 95%; /* Ocupa el ancho completo del contenedor principal */
            max-width: 450px; /* Limita el ancho */
            transition: all 0.3s ease-in-out; /* Transición para mostrar/ocultar */
            flex-direction: column; /* Asegura que los elementos del formulario estén en columna */
            gap: 1rem; /* Espacio entre los elementos del formulario */
        }
        #alarmInputForm.hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }
        #alarmInputForm.show {
            display: flex; /* Cambiado de 'block' a 'flex' para mantener la columna */
            opacity: 1;
            transform: translateY(0);
        }

        /* Estilos para el display de alarma sonando (cubre toda la pantalla) */
        #ringingAlarmDisplay {
            position: fixed; /* Fijo en la pantalla */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            color: #ffffff; /* Texto blanco para contrastar con fondos de colores */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); /* Sombra para el texto */
            z-index: 1000; /* Asegura que esté por encima de todo */
        }
        #ringingAlarmDisplay.show {
            opacity: 1;
            visibility: visible;
        }
        #ringingAlarmDisplay h2 {
            font-size: 3rem; /* Más grande para el mensaje de alarma */
            font-weight: 800;
            margin-bottom: 1rem;
        }
        #ringingAlarmDisplay p {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        #ringingAlarmDisplay button {
            margin-top: 2rem;
            width: auto; /* Botón de detener más pequeño */
            padding: 1rem 2.5rem;
            background-color: rgba(255, 255, 255, 0.2); /* Botón semi-transparente */
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: #ffffff;
        }
        #ringingAlarmDisplay button:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Estilos para el mensaje temporal de alerta/confirmación (directamente en la página) */
        #messageDisplay, #confirmDisplay {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            font-size: 1rem;
            color: #334155;
            margin-top: 1rem;
            transition: opacity 0.3s ease-out;
            opacity: 1;
            width: 95%;
            max-width: 350px;
            z-index: 900; /* Para que esté por encima de la lista/formulario */
        }
        #messageDisplay.hidden, #confirmDisplay.hidden {
            opacity: 0;
            height: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
        #confirmDisplay p {
            margin-bottom: 1rem;
        }
        #confirmDisplay .flex {
            gap: 1rem;
            justify-content: center;
        }
        #confirmDisplay button {
            width: auto;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen">

    <!-- Displays current time - Ubicado en la parte central superior de la página -->
    <div id="currentTime" class="text-5xl font-extrabold text-indigo-700"></div>

    <!-- Button to add a new alarm -->
    <button id="addAlarmBtn" class="btn-primary">
        <i class="fas fa-plus-circle"></i> Añadir Nueva Alarma
    </button>

    <!-- Form for adding/editing alarm, initially hidden -->
    <div id="alarmInputForm" class="hidden">
        <label for="alarmTimeInput" class="text-left text-sm font-medium text-gray-700">Hora de la Alarma:</label>
        <input type="time" id="alarmTimeInput">

        <label for="alarmNameInput" class="text-left text-sm font-medium text-gray-700">Nombre de la Alarma (opcional):</label>
        <input type="text" id="alarmNameInput" placeholder="Ej. Despertar, Reunión">

        <label for="alarmToneSelect" class="text-left text-sm font-medium text-gray-700">Tono de Alarma:</label>
        <select id="alarmToneSelect">
            <!-- Tone options will be loaded with JS -->
        </select>

        <label for="alarmBackgroundSelect" class="text-left text-sm font-medium text-gray-700">Fondo de Alarma:</label>
        <select id="alarmBackgroundSelect">
            <!-- Background options will be loaded with JS -->
        </select>

        <button id="saveAlarmBtn" class="btn-primary">Guardar Alarma</button>
        <button id="cancelAddBtn" class="btn-secondary">Cancelar</button>
    </div>

    <!-- Temporary message display for alerts -->
    <div id="messageDisplay" class="hidden"></div>
    <!-- Temporary confirmation display -->
    <div id="confirmDisplay" class="hidden">
        <p id="confirmMessage" class=""></p>
        <div class="flex justify-center gap-4">
            <button id="confirmYesBtn" class="btn-primary">Sí</button>
            <button id="confirmNoBtn" class="btn-secondary">No</button>
        </div>
    </div>

    <!-- List of configured alarms -->
    <div id="alarmsList" class="w-full mt-4">
        <!-- Alarms will be rendered here -->
        <p id="noAlarmsMessage" class="text-gray-500 text-center text-lg mt-4">No hay alarmas configuradas.</p>
    </div>

    <!-- Ringing Alarm Display (covers the whole screen when active) -->
    <div id="ringingAlarmDisplay" class="hidden">
        <h2 class="">¡ALARM!</h2>
        <p id="ringingDisplayTime" class=""></p>
        <p id="ringingDisplayName" class=""></p>
        <button id="stopRingingAlarmBtn" class="btn-primary">Detener Alarma</button>
    </div>

    <script>
        // Get DOM element references
        const currentTimeDisplay = document.getElementById('currentTime');
        const addAlarmBtn = document.getElementById('addAlarmBtn');
        const alarmsList = document.getElementById('alarmsList');
        const noAlarmsMessage = document.getElementById('noAlarmsMessage');

        // Form for adding/editing alarm (replaces the modal)
        const alarmInputForm = document.getElementById('alarmInputForm');
        const alarmTimeInput = document.getElementById('alarmTimeInput');
        const alarmNameInput = document.getElementById('alarmNameInput');
        const alarmToneSelect = document.getElementById('alarmToneSelect');
        const alarmBackgroundSelect = document.getElementById('alarmBackgroundSelect');
        const saveAlarmBtn = document.getElementById('saveAlarmBtn');
        const cancelAddBtn = document.getElementById('cancelAddBtn');

        // Temporary message display
        const messageDisplay = document.getElementById('messageDisplay');
        const confirmDisplay = document.getElementById('confirmDisplay');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        // Ringing Alarm Display
        const ringingAlarmDisplay = document.getElementById('ringingAlarmDisplay');
        const ringingDisplayTime = document.getElementById('ringingDisplayTime');
        const ringingDisplayName = document.getElementById('ringingDisplayName');
        const stopRingingAlarmBtn = document.getElementById('stopRingingAlarmBtn');

        let alarms = []; // Array to store all alarms
        let currentRingingAlarmId = null; // To track which alarm is currently ringing
        let editingAlarmId = null; // To track which alarm is being edited

        // Definition of alarm tones
        const alarmTones = [
            { name: 'Campana Simple', url: 'https://www.soundjay.com/buttons/beep-07.wav' },
            { name: 'Timbre Clásico', url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav' },
            { name: 'Alarma Digital', url: 'https://www.soundjay.com/misc/sounds/alarm-clock-01.wav' },
            { name: 'Sonido Suave', url: 'https://www.soundjay.com/misc/sounds/soft-chime-01.wav' }
        ];

        // Definition of backgrounds for the alarm display when ringing
        const alarmBackgrounds = [
            { name: 'Blanco Clásico', value: '#ffffff' },
            { name: 'Azul Suave', value: '#e0f2fe' },
            { name: 'Verde Relajante', value: '#e6ffed' },
            { name: 'Rosa Vibrante', value: '#ffe6f0' },
            { name: 'Morado Degradado', value: 'linear-gradient(45deg, #a855f7, #6366f1)' },
            { name: 'Naranja Cálido', value: 'linear-gradient(45deg, #f97316, #fbbf24)' },
            { name: 'Cielo Azul', value: 'linear-gradient(45deg, #38b2ac, #667eea)' }
        ];

        let audio = new Audio(); // Create an Audio object
        audio.loop = true; // Loop the alarm sound

        // Load alarms from localStorage on startup
        function loadAlarms() {
            const storedAlarms = localStorage.getItem('alarms');
            if (storedAlarms) {
                alarms = JSON.parse(storedAlarms);
            }
            renderAlarms(); // Render the loaded alarms
        }

        // Save alarms to localStorage
        function saveAlarms() {
            localStorage.setItem('alarms', JSON.stringify(alarms));
        }

        // Generate a unique ID (simplified UUID v4)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Render the list of alarms in the DOM
        function renderAlarms() {
            alarmsList.innerHTML = ''; // Clear existing list
            if (alarms.length === 0) {
                noAlarmsMessage.style.display = 'block';
                alarmsList.appendChild(noAlarmsMessage);
                return;
            } else {
                noAlarmsMessage.style.display = 'none';
            }

            // Sort alarms by time
            alarms.sort((a, b) => {
                const [hA, mA] = a.time.split(':').map(Number);
                const [hB, mB] = b.time.split(':').map(Number);
                if (hA === hB) return mA - mB;
                return hA - hB;
            });

            alarms.forEach(alarm => {
                const alarmItem = document.createElement('div');
                alarmItem.className = `alarm-item ${alarm.active ? '' : 'inactive'}`;
                alarmItem.dataset.id = alarm.id; // Store ID in the element for easy access

                // Find the tone and background names to display them
                const toneName = alarmTones.find(t => t.url === alarm.tone)?.name || 'Tono por defecto';
                const backgroundName = alarmBackgrounds.find(b => b.value === alarm.background)?.name || 'Fondo por defecto';

                alarmItem.innerHTML = `
                    <div class="alarm-info">
                        <span class="alarm-time">${alarm.time}</span>
                        <span class="alarm-name">${alarm.name || 'Alarma'}</span>
                        <span class="alarm-details">Tono: ${toneName} | Fondo: ${backgroundName}</span>
                    </div>
                    <div class="alarm-actions">
                        <label class="toggle-switch">
                            <input type="checkbox" ${alarm.active ? 'checked' : ''} data-id="${alarm.id}">
                            <span class="slider"></span>
                        </label>
                        <button class="btn-action btn-delete" data-id="${alarm.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                alarmsList.appendChild(alarmItem);
            });

            // Add event listeners to new delete buttons and toggles
            document.querySelectorAll('.btn-delete').forEach(button => {
                button.onclick = (e) => deleteAlarm(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                toggle.onchange = (e) => toggleAlarm(e.currentTarget.dataset.id);
            });
        }

        // Populate tone and background select dropdowns
        function populateToneAndBackgroundSelects() {
            alarmToneSelect.innerHTML = '';
            alarmTones.forEach(tone => {
                const option = document.createElement('option');
                option.value = tone.url;
                option.textContent = tone.name;
                alarmToneSelect.appendChild(option);
            });

            alarmBackgroundSelect.innerHTML = '';
            alarmBackgrounds.forEach(bg => {
                const option = document.createElement('option');
                option.value = bg.value;
                option.textContent = bg.name;
                alarmBackgroundSelect.appendChild(option);
            });
        }

        // Show the add/edit alarm form
        function showAlarmForm(alarmToEdit = null) {
            populateToneAndBackgroundSelects(); // Ensure selects are populated

            if (alarmToEdit) {
                // For editing, populate the form fields
                alarmTimeInput.value = alarmToEdit.time;
                alarmNameInput.value = alarmToEdit.name;
                alarmToneSelect.value = alarmToEdit.tone || alarmTones[0].url;
                alarmBackgroundSelect.value = alarmToEdit.background || alarmBackgrounds[0].value;
                editingAlarmId = alarmToEdit.id;
            } else {
                // For new alarm, clear fields
                alarmTimeInput.value = '';
                alarmNameInput.value = '';
                alarmToneSelect.value = alarmTones[0].url; // Default value
                alarmBackgroundSelect.value = alarmBackgrounds[0].value; // Default value
                editingAlarmId = null; // Ensure it's null for new alarms
            }
            alarmInputForm.classList.remove('hidden');
            alarmInputForm.classList.add('show');
            addAlarmBtn.style.display = 'none'; // Hide the "Add New Alarm" button
        }

        // Hide the add/edit alarm form
        function hideAlarmForm() {
            alarmInputForm.classList.remove('show');
            alarmInputForm.classList.add('hidden');
            addAlarmBtn.style.display = 'flex'; // Show the "Add New Alarm" button
        }

        // Save or update an alarm from the form
        function saveAlarm() {
            const time = alarmTimeInput.value;
            const name = alarmNameInput.value.trim();
            const tone = alarmToneSelect.value;
            const background = alarmBackgroundSelect.value;
            
            if (!time) {
                alertUser('Por favor, selecciona una hora para la alarma.');
                return;
            }

            if (editingAlarmId) {
                // Edit existing alarm
                const index = alarms.findIndex(alarm => alarm.id === editingAlarmId);
                if (index !== -1) {
                    alarms[index].time = time;
                    alarms[index].name = name;
                    alarms[index].tone = tone;
                    alarms[index].background = background;
                }
            } else {
                // Add new alarm
                const newAlarm = {
                    id: generateUUID(),
                    time: time,
                    name: name,
                    active: true, // New alarm active by default
                    tone: tone,
                    background: background
                };
                alarms.push(newAlarm);
            }
            saveAlarms();
            renderAlarms();
            hideAlarmForm();
            alertUser('Alarma guardada con éxito.');
        }

        // Delete an alarm
        function deleteAlarm(id) {
            showConfirm('¿Estás seguro de que quieres eliminar esta alarma?', () => {
                alarms = alarms.filter(alarm => alarm.id !== id);
                saveAlarms();
                renderAlarms();
                alertUser('Alarma eliminada.');
            });
        }

        // Activate/deactivate an alarm
        function toggleAlarm(id) {
            const alarm = alarms.find(a => a.id === id);
            if (alarm) {
                alarm.active = !alarm.active;
                saveAlarms();
                renderAlarms(); // Re-render to update style
                alertUser(`Alarma ${alarm.active ? 'activada' : 'desactivada'}.`);
            }
        }

        // Function to update current time and check alarms
        function updateCurrentTimeAndCheckAlarms() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            currentTimeDisplay.textContent = `${hours}:${minutes}:${seconds}`;

            // Check if any alarm should ring
            alarms.forEach(alarm => {
                if (alarm.active) {
                    const [alarmHour, alarmMinute] = alarm.time.split(':').map(Number);
                    // Only activate the alarm once per exact minute
                    if (now.getHours() === alarmHour && now.getMinutes() === alarmMinute && now.getSeconds() === 0) {
                        // Prevent from ringing multiple times in the same minute or if it already rang
                        if (currentRingingAlarmId !== alarm.id) {
                            currentRingingAlarmId = alarm.id; // Mark this alarm as currently ringing
                            triggerAlarm(alarm);
                            // Optional: Deactivate alarm after it rings
                            // alarm.active = false;
                            // saveAlarms();
                            // renderAlarms();
                        }
                    } else {
                        // Reset currentRingingAlarmId if alarm time has passed
                        // This allows the alarm to ring again the next day
                        if (currentRingingAlarmId === alarm.id && (now.getHours() !== alarmHour || now.getMinutes() !== alarmMinute)) {
                            currentRingingAlarmId = null;
                        }
                    }
                }
            });
        }

        // Function to trigger the alarm (show message and play sound)
        function triggerAlarm(alarm) {
            ringingDisplayTime.textContent = `Hora: ${alarm.time}`;
            ringingDisplayName.textContent = `Nombre: ${alarm.name || 'Alarma'}`;
            
            // Set the alarm tone
            if (audio.src !== alarm.tone) { // Only change if different
                audio.src = alarm.tone;
            }
            audio.play().catch(e => console.error("Error playing audio:", e)); // Add catch for playback errors

            // Apply background to the ringing display
            ringingAlarmDisplay.style.background = alarm.background;

            ringingAlarmDisplay.classList.add('show');

            // --- Notification Logic ---
            if (Notification.permission === 'granted') {
                const notificationTitle = '¡Alarma!';
                const notificationOptions = {
                    body: `Es la hora de tu alarma: ${alarm.time} - ${alarm.name || 'Alarma'}`,
                    // You can add an icon here if you have one, e.g., icon: '/path/to/alarm-icon.png'
                    tag: `alarm-${alarm.id}` // Unique tag for this notification
                };

                const notification = new Notification(notificationTitle, notificationOptions);

                // Optional: Focus the tab when notification is clicked and stop alarm
                notification.onclick = function(event) {
                    event.preventDefault(); // Prevent the browser from focusing a different tab
                    window.focus(); // Focus the current window/tab
                    stopRingingAlarm(); // Stop the alarm sound and hide display
                };
            } else if (Notification.permission === 'default') {
                console.warn("Permiso de notificación no concedido. No se puede enviar notificación.");
            }
            // --- End Notification Logic ---
        }

        // Function to stop the alarm (hide message and pause sound)
        function stopRingingAlarm() {
            ringingAlarmDisplay.classList.remove('show');
            audio.pause();
            audio.currentTime = 0; // Reset sound for next time
            currentRingingAlarmId = null; // Clear the alarm that was ringing
            ringingAlarmDisplay.style.background = ''; // Clear background
        }

        // Function to show user messages (replaces alert() with a custom, non-blocking message)
        let messageTimeout;
        function alertUser(message) {
            clearTimeout(messageTimeout); // Clear any existing timeout
            messageDisplay.textContent = message;
            messageDisplay.classList.remove('hidden');
            messageDisplay.classList.add('show');

            messageTimeout = setTimeout(() => {
                messageDisplay.classList.remove('show');
                messageDisplay.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        // Function to show a confirmation (replaces confirm() with a custom, non-blocking UI)
        let confirmCallback = null;
        function showConfirm(message, onConfirm, onCancel = null) {
            confirmMessage.textContent = message;
            confirmDisplay.classList.remove('hidden');
            confirmDisplay.classList.add('show');
            
            confirmCallback = onConfirm; // Store the callback

            confirmYesBtn.onclick = () => {
                confirmDisplay.classList.remove('show');
                confirmDisplay.classList.add('hidden');
                if (confirmCallback) confirmCallback();
                confirmCallback = null; // Clear callback
            };

            confirmNoBtn.onclick = () => {
                confirmDisplay.classList.remove('show');
                confirmDisplay.classList.add('hidden');
                if (onCancel) onCancel();
                confirmCallback = null; // Clear callback
            };
        }

        // New function to request notification permission
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.warn("Este navegador no soporta notificaciones de escritorio.");
                return;
            }

            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log("Permiso de notificación concedido.");
                        alertUser("Permiso para notificaciones concedido. ¡Las alarmas sonarán incluso si la pestaña está en segundo plano!");
                    } else {
                        console.warn("Permiso de notificación denegado.");
                        alertUser("Permiso para notificaciones denegado. Las alarmas solo sonarán cuando la pestaña esté activa.");
                    }
                });
            } else if (Notification.permission === 'denied') {
                console.warn("Permiso de notificación denegado previamente. El usuario debe cambiarlo manualmente en la configuración del navegador.");
                alertUser("Las notificaciones están bloqueadas. Por favor, habilítalas en la configuración de tu navegador para recibir alertas de alarma.");
            } else {
                console.log("Permiso de notificación ya concedido.");
            }
        }


        // Event Listeners
        addAlarmBtn.addEventListener('click', () => showAlarmForm());
        cancelAddBtn.addEventListener('click', hideAlarmForm);
        saveAlarmBtn.addEventListener('click', saveAlarm);
        stopRingingAlarmBtn.addEventListener('click', stopRingingAlarm);

        // Start updating current time and loading alarms on page load
        window.onload = function() {
            requestNotificationPermission(); // Request permission on load
            loadAlarms(); // Load and render existing alarms
            updateCurrentTimeAndCheckAlarms(); // Update time immediately on load
            setInterval(updateCurrentTimeAndCheckAlarms, 1000); // Update every second
        };
    </script>
</body>
</html>
