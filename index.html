<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Variables for Theming */
        :root {
            --color-primary: #4CAF50;
            --color-primary-dark: #43A047;
            --color-secondary-blue: #2196F3;
            --color-secondary-blue-dark: #1976D2;
            --color-darkblue: #3B3B6B;
            --color-background: #f0f2f5;
            --color-surface: #ffffff;
            --color-text-default: #374151; /* gray-800 */
            --color-text-secondary: #6B7280; /* gray-500 */
            --color-border: #E5E7EB; /* gray-200 */
            --color-input-border: #D1D5DB; /* gray-300 */
            --color-message-bg-self: var(--color-secondary-blue);
            --color-message-text-self: #ffffff;
            --color-message-bg-other: #e5e7eb; /* gray-200 */
            --color-message-text-other: #374151; /* gray-800 */
            --color-green-status: #22C55E; /* green-500 */
            --color-gray-status: #9CA3AF; /* gray-400 */
            --color-red-error: #EF4444; /* red-600 */
            --color-green-success: #22C55E; /* green-600 */
            --color-blue-info: #3B82F6; /* blue-500 */
        }

        .dark-mode {
            --color-primary: #66BB6A; /* Lighter green for dark mode */
            --color-primary-dark: #81C784;
            --color-secondary-blue: #64B5F6; /* Lighter blue for dark mode */
            --color-secondary-blue-dark: #90CAF9;
            --color-darkblue: #B0BEC5; /* Lighter text for dark mode */
            --color-background: #000000; /* Pure black background */
            --color-surface: #0a0a0a; /* Very dark surface for cards/panels */
            --color-text-default: #E2E8F0; /* Light gray text */
            --color-text-secondary: #A0AEC0; /* Lighter gray secondary text */
            --color-border: #333333; /* Darker border */
            --color-input-border: #444444; /* Darker input border */
            --color-message-bg-self: var(--color-secondary-blue);
            --color-message-text-self: #ffffff;
            --color-message-bg-other: #333333; /* Darker gray for other messages */
            --color-message-text-other: #E2E8F0; /* Light text for other messages */
            --color-green-status: #4CAF50; /* Adjust for dark mode visibility */
            --color-gray-status: #6B7280; /* Adjust for dark mode visibility */
            --color-red-error: #F87171; /* Adjust for dark mode visibility */
            --color-green-success: #4CAF50; /* Adjust for dark mode visibility */
            --color-blue-info: #60A5FA; /* Adjust for dark mode visibility */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-default);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Applying CSS variables to Tailwind-like classes */
        .bg-custom-primary { background-color: var(--color-primary); }
        .hover\:bg-custom-primary-dark:hover { background-color: var(--color-primary-dark); }
        .focus\:ring-custom-primary { --tw-ring-color: var(--color-primary); }

        .text-custom-darkblue { color: var(--color-darkblue); }
        .bg-custom-secondary-blue { background-color: var(--color-secondary-blue); }
        .hover\:bg-custom-secondary-blue-dark:hover { background-color: var(--color-secondary-blue-dark); }
        .focus\:ring-custom-secondary-blue { --tw-ring-color: var(--color-secondary-blue); }

        /* General element styling based on variables */
        .bg-white { background-color: var(--color-surface); }
        .bg-gray-100 { background-color: var(--color-background); } /* Main app background */
        .bg-gray-50 { background-color: var(--color-background); } /* Chat area, lists background */
        .bg-gray-200 { background-color: var(--color-message-bg-other); color: var(--color-message-text-other); } /* Other messages, general gray buttons */
        .hover\:bg-gray-200:hover { background-color: var(--color-border); } /* Hover for lists */
        .hover\:bg-gray-300:hover { background-color: var(--color-border); } /* Hover for buttons */

        .text-gray-700 { color: var(--color-text-default); }
        .text-gray-800 { color: var(--color-text-default); }
        .text-gray-500 { color: var(--color-text-secondary); }
        .text-gray-600 { color: var(--color-text-secondary); }

        .border-gray-200 { border-color: var(--color-border); }
        .border-gray-300 { border-color: var(--color-input-border); }

        .text-red-500 { color: var(--color-red-error); }
        .hover\:text-red-700:hover { color: var(--color-red-error); }
        .text-red-600 { color: var(--color-red-error); }
        .text-green-600 { color: var(--color-green-success); }
        .text-blue-200 { color: var(--color-text-secondary); } /* For sender name in self message */
        .text-blue-300 { color: var(--color-text-secondary); } /* For timestamp in self message */
        .bg-green-500 { background-color: var(--color-green-status); }
        .bg-gray-400 { background-color: var(--color-gray-status); }
        .bg-green-50 { background-color: var(--color-green-success); }
        .bg-red-50 { background-color: var(--color-red-error); }
        .bg-blue-50 { background-color: var(--color-blue-info); }

        /* Custom scrollbar for chat messages */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: var(--color-background);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--color-text-secondary);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--color-darkblue);
        }
        /* Custom modal styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: var(--color-surface);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            color: var(--color-text-default);
        }
        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }

        /* --- NEW/MODIFIED CSS FOR CHAT MESSAGES --- */
        #chat-messages-container {
            padding: 1rem; /* Added padding to the chat container itself */
        }

        .message-container {
            display: flex; /* Use flexbox for message alignment */
            margin-bottom: 0.75rem; /* Space between messages */
            align-items: flex-end; /* Align sender pic/name to bottom of bubble */
            max-width: 100%; /* Ensure container doesn't overflow */
        }

        .message-container.self {
            justify-content: flex-end; /* Align self messages to the right */
        }

        .message-container.other {
            justify-content: flex-start; /* Align other messages to the left */
        }

        .message-avatar {
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            border-radius: 9999px; /* rounded-full */
            object-fit: cover;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .message-container.other .message-avatar {
            margin-right: 0.5rem; /* Space between avatar and message bubble */
        }

        .message-container.self .message-avatar {
            margin-left: 0.5rem; /* Space between message bubble and avatar */
            order: 2; /* Place avatar after message bubble for self messages */
        }

        .message-bubble {
            padding: 0.625rem 1rem; /* py-2.5 px-4, more breathing room inside */
            border-radius: 0.75rem; /* rounded-xl */
            max-width: 70%; /* Limit bubble width to 70% of container */
            word-wrap: break-word; /* Ensure long words break */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* subtle shadow */
            position: relative;
        }

        .message-bubble.self {
            background-color: var(--color-message-bg-self);
            color: var(--color-message-text-self);
            margin-left: auto; /* Push to the right */
            border-bottom-right-radius: 0.25rem; /* Tweak corner for self */
        }

        .message-bubble.other {
            background-color: var(--color-message-bg-other);
            color: var(--color-message-text-other);
            margin-right: auto; /* Push to the left */
            border-bottom-left-radius: 0.25rem; /* Tweak corner for other */
        }

        .message-sender {
            font-weight: 600; /* semibold */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 0.25rem; /* space below sender name */
            color: var(--color-text-default); /* Default for other messages */
        }

        .message-bubble.self .message-sender {
            color: rgba(255, 255, 255, 0.9); /* Lighter sender name for self messages */
        }

        .message-content {
            font-size: 1rem; /* text-base */
            line-height: 1.5;
        }

        .message-timestamp {
            font-size: 0.75rem; /* text-xs */
            color: var(--color-text-secondary);
            text-align: right;
            margin-top: 0.25rem;
            opacity: 0.8;
            line-height: 1; /* Tighter line height for timestamp */
        }

        .message-bubble.self .message-timestamp {
            color: rgba(255, 255, 255, 0.7); /* Lighter timestamp for self messages */
        }
        /* --- END NEW/MODIFIED CSS FOR CHAT MESSAGES --- */

    </style>
</head>
<body class="h-screen flex items-center justify-center">

    <div id="auth-section" class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
        <div class="flex justify-center mb-6">
            <img src="https://i.imgur.com/CJHtqu5.jpeg" alt="SynergiCode Logo" class="w-48 h-auto">
        </div>
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6" id="auth-title">Iniciar Sesión</h2>
        <form id="auth-form" class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
            </div>
            <div id="register-fields" class="space-y-4 hidden">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Nombre de Usuario (opcional)</label>
                    <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Número de Teléfono</label>
                    <input type="tel" id="phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" placeholder="+58XXXXXXXXX" pattern="^\+\d{1,3}\d{7,15}$" title="Formato: +CódigoDePaísNúmero (ej. +584123456789)">
                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                    <input type="date" id="dob" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm">
                </div>
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700">Edad</label>
                    <input type="number" id="age" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" min="0" max="120">
                </div>
            </div>
            <button type="submit" id="auth-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-custom-primary hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">
                Iniciar Sesión
            </button>
        </form>
        <p class="mt-4 text-center text-sm text-gray-600">
            ¿No tienes una cuenta? <button id="toggle-auth" class="font-medium text-custom-secondary-blue hover:text-custom-secondary-blue-dark">Regístrate</button>
        </p>
        <p class="mt-2 text-center text-sm">
            <button id="forgot-password-link" class="font-medium text-custom-secondary-blue hover:text-custom-secondary-blue-dark">¿Olvidaste tu contraseña?</button>
        </p>
        <div id="auth-message" class="mt-4 text-center text-sm text-red-600"></div>
    </div>

    <div id="app-section" class="hidden h-screen w-full flex flex-col md:flex-row bg-gray-100 rounded-xl shadow-xl overflow-hidden">
        <div id="sidebar" class="w-full max-w-xs md:w-1/4 bg-custom-surface border-r border-gray-200 flex-col md:flex fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-custom-darkblue dark:text-white">ChatApp</h1>
                <button id="logout-button" class="text-red-500 hover:text-red-700 text-sm font-medium hidden md:block">
                    <i class="fas fa-sign-out-alt mr-1"></i>Salir
                </button>
                <button id="close-sidebar-button" class="md:hidden text-gray-700 hover:text-gray-900 p-2 rounded-md">
                    <i class="fas fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="p-4 flex flex-col items-center border-b border-gray-200">
                <div class="mb-4">
                    <img src="https://i.imgur.com/CJHtqu5.jpeg" alt="SynergiCode Logo" class="w-24 h-auto">
                </div>
                <div class="relative">
                    <img id="profile-pic" src="https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF" alt="Foto de Perfil" class="w-24 h-24 rounded-full object-cover border-2 border-custom-secondary-blue mb-2">
                    <input type="file" id="profile-pic-upload" accept="image/*" class="hidden-file-input">
                    <button id="upload-pic-button" class="absolute bottom-0 right-0 bg-custom-secondary-blue text-white rounded-full p-2 text-xs shadow-md hover:bg-custom-secondary-blue-dark transition-colors duration-200">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <p id="user-display-username" class="text-xl font-bold text-custom-darkblue"></p>

                <div id="email-verification-status-sidebar" class="text-xs text-gray-500 mt-1 text-center">
                    <span id="email-verified-text"></span>
                    <button id="resend-verification-email-sidebar" class="hidden mt-1 text-custom-secondary-blue hover:text-custom-secondary-blue-dark font-medium">
                        Reenviar Email de Verificación
                    </button>
                </div>

                <p id="user-phone-display" class="text-xs text-gray-500"></p>
                <p id="user-dob-display" class="text-xs text-gray-500"></p>
                <p id="user-age-display" class="text-xs text-gray-500"></p>
                <button id="change-username-button" class="mt-4 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    <i class="fas fa-user-edit mr-2"></i>Cambiar Nombre de Usuario
                </button>
                <button id="theme-toggle-button" class="mt-2 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    <i class="fas fa-sun mr-2"></i>Cambiar Tema
                </button>
            </div>
            <div class="p-4 border-t border-gray-200 mt-auto">
                <button id="add-contact-button" class="w-full bg-custom-primary text-white py-2 px-4 rounded-md hover:bg-custom-primary-dark transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">
                    <i class="fas fa-user-plus mr-2"></i>Añadir Contacto
                </button>
                <button id="create-group-button" class="w-full mt-2 bg-custom-primary text-white py-2 px-4 rounded-md hover:bg-custom-primary-dark transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">
                    <i class="fas fa-plus-circle mr-2"></i>Crear Grupo
                </button>
                <button id="mobile-logout-button" class="w-full mt-2 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 md:hidden">
                    <i class="fas fa-sign-out-alt mr-1"></i>Salir
                </button>
            </div>
        </div>

        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>

        <div class="w-full md:w-3/4 flex flex-col">
            <div class="md:hidden p-2 bg-custom-surface border-b border-gray-200 flex justify-between items-center">
                <button id="mobile-sidebar-toggle" class="p-2 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200">
                    <i class="fas fa-bars"></i>
                </button>
                <img src="https://i.imgur.com/CJHtqu5.jpeg" alt="SynergiCode Logo" class="w-12 h-auto">
            </div>

            <nav class="bg-custom-surface p-4 border-b border-gray-200 flex flex-wrap items-center justify-around">
                <button id="show-contacts" class="flex-1 text-center p-3 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 mx-1">
                    <i class="fas fa-address-book mr-2"></i>Contactos
                </button>
                <button id="show-groups" class="flex-1 text-center p-3 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 mx-1">
                    <i class="fas fa-users mr-2"></i>Grupos de Trabajo
                </button>
                <button id="show-notifications-button" class="flex-1 text-center p-3 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 relative mx-1">
                    <i class="fas fa-bell mr-2"></i>Notificaciones
                    <span id="notification-badge" class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
                <button id="show-friend-requests-button" class="flex-1 text-center p-3 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 relative mx-1">
                    <i class="fas fa-user-friends mr-2"></i>Solicitudes
                    <span id="friend-request-badge" class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
            </nav>

            <div id="chat-header" class="bg-custom-surface p-4 border-b border-gray-200 flex items-center justify-between">
                <div class="flex items-center">
                    <img id="current-chat-pic" src="https://placehold.co/50x50/E2E8F0/4A5568?text=Chat" alt="Chat Pic" class="w-12 h-12 rounded-full object-cover mr-3">
                    <div>
                        <h2 id="current-chat-name" class="text-xl font-semibold text-gray-800">Selecciona un chat</h2>
                        <p id="current-chat-status" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="flex space-x-2 ml-auto">
                    <button id="add-group-member-button" class="hidden px-3 py-1 bg-custom-primary text-white text-sm rounded-md hover:bg-custom-primary-dark transition-colors">
                        Añadir Miembro
                    </button>
                    <button id="leave-group-button" class="hidden px-3 py-1 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition-colors">
                        Salir del Grupo
                    </button>
                </div>
            </div>

            <div id="chat-messages-container" class="flex-grow p-4 overflow-y-auto chat-messages bg-gray-50">
                </div>

            <div id="message-input-area" class="bg-custom-surface p-4 border-t border-gray-200 flex items-center hidden">
                <input type="file" id="chat-media-upload" accept="image/*,video/*" class="hidden-file-input">
                <button id="attach-media-button" class="mr-3 bg-gray-200 text-gray-700 p-3 rounded-full hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="text" id="message-input" class="flex-grow px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue" placeholder="Escribe un mensaje...">
                <button id="send-message-button" class="ml-3 bg-custom-primary text-white p-3 rounded-full hover:bg-custom-primary-dark transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <div id="no-chat-selected" class="flex-grow flex items-center justify-center text-gray-500 text-lg">
                <p>Selecciona un contacto o grupo para empezar a chatear.</p>
            </div>

            <div id="contacts-list-view" class="flex-grow p-4 overflow-y-auto bg-gray-50 w-full">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Mis Contactos</h3>
                <ul id="contacts-list" class="space-y-2">
                    </ul>
                <p id="no-contacts-message" class="text-center text-gray-500 mt-4 hidden">No tienes contactos. Añade uno para empezar a chatear.</p>
            </div>

            <div id="groups-list-view" class="flex-grow p-4 overflow-y-auto bg-gray-50 w-full hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Mis Grupos de Trabajo</h3>
                <ul id="groups-list" class="space-y-2">
                    </ul>
                <p id="no-groups-message" class="text-center text-gray-500 mt-4 hidden">No tienes grupos. Crea uno para empezar a colaborar.</p>
            </div>

            <div id="friend-requests-list-view" class="flex-grow p-4 overflow-y-auto bg-gray-50 w-full hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Solicitudes de Amistad</h3>
                <ul id="friend-requests-list" class="space-y-2">
                    </ul>
                <p id="no-friend-requests-message" class="text-center text-gray-500 mt-4 hidden">No tienes solicitudes de amistad.</p>
            </div>
        </div>
    </div>

    <div id="add-contact-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Añadir Contacto</h3>
            <form id="add-contact-form" class="space-y-4">
                <div>
                    <label for="contact-input" class="block text-sm font-medium text-gray-700">Correo Electrónico o Nombre de Usuario</label>
                    <input type="text" id="contact-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-add-contact" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">Enviar Solicitud</button>
                </div>
                <p id="add-contact-message" class="text-sm text-red-600"></p>
            </form>
        </div>
    </div>

    <div id="create-group-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Crear Nuevo Grupo de Trabajo</h3>
            <form id="create-group-form" class="space-y-4">
                <div>
                    <label for="group-name" class="block text-sm font-medium text-gray-700">Nombre del Grupo</label>
                    <input type="text" id="group-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
                </div>
                <div>
                    <label for="group-description" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                    <textarea id="group-description" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="group-photo-upload" class="block text-sm font-medium text-gray-700">Foto del Grupo (Opcional)</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <img id="group-photo-preview" src="https://placehold.co/80x80/E2E8F0/4A5568?text=Grupo" alt="Group Photo Preview" class="w-20 h-20 rounded-full object-cover border-2 border-gray-300">
                        <input type="file" id="group-photo-upload" accept="image/*" class="hidden-file-input">
                        <button type="button" id="upload-group-pic-button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                            <i class="fas fa-upload mr-2"></i>Subir Foto
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Miembros (selecciona contactos)</label>
                    <div id="group-member-selection" class="mt-1 border border-gray-300 rounded-md p-2 max-h-40 overflow-y-auto space-y-1">
                        <p id="no-contacts-for-group" class="text-sm text-gray-500 hidden">Añade contactos para poder agregarlos a un grupo.</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-create-group" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">Crear Grupo</button>
                </div>
                <p id="create-group-message" class="text-sm text-red-600"></p>
            </form>
        </div>
    </div>

    <div id="add-group-member-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4">Añadir Miembro al Grupo</h3>
            <form id="add-group-member-form">
                <div class="mb-4">
                    <label for="add-group-member-input" class="block text-sm font-medium text-gray-700 mb-1">Email o Nombre de Usuario</label>
                    <input type="text" id="add-group-member-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-custom-primary focus:border-custom-primary">
                </div>
                <p id="add-group-member-message" class="text-red-500 text-sm mb-4"></p>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-add-group-member" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark transition-colors">Añadir</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="confirm-modal-title" class="text-lg font-semibold mb-4">Confirmación</h3>
            <p id="confirm-modal-content" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button id="confirm-modal-ok" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="message-box" class="hidden fixed inset-0 flex items-center justify-center z-[999] modal-overlay">
        <div class="modal-content p-6 w-full max-w-sm text-center">
            <h3 id="message-box-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="message-box-content" class="text-gray-700 mb-6"></p>
            <button id="message-box-ok" class="px-6 py-2 bg-custom-secondary-blue text-white rounded-md hover:bg-custom-secondary-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">OK</button>
        </div>
    </div>

    <div id="email-sent-modal" class="hidden fixed inset-0 flex items-center justify-center z-[999] modal-overlay">
        <div class="modal-content p-8 w-full max-w-sm text-center">
            <div class="text-custom-primary text-6xl mb-4">
                <i class="fas fa-envelope-circle-check"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">¡Email Enviado!</h3>
            <p class="text-gray-700 mb-6">Por favor, revisa tu bandeja de entrada y haz clic en el enlace de verificación para activar tu cuenta.</p>
            <button id="email-sent-ok" class="px-6 py-2 bg-custom-secondary-blue text-white rounded-md hover:bg-custom-secondary-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Entendido</button>
        </div>
    </div>

    <div id="forgot-password-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Recuperar Contraseña</h3>
            <form id="forgot-password-form" class="space-y-4">
                <div>
                    <label for="forgot-email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="forgot-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-forgot-password" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">Enviar Enlace</button>
                </div>
                <p id="forgot-password-message" class="text-sm text-red-600"></p>
            </form>
        </div>
    </div>

    <div id="notifications-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Notificaciones</h3>
            <ul id="notifications-list" class="space-y-3 max-h-80 overflow-y-auto mb-4">
                </ul>
            <p id="no-notifications-message" class="text-center text-gray-500 hidden">No tienes notificaciones nuevas.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="clear-notifications-button" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Borrar Todas</button>
                <button type="button" id="close-notifications-modal" class="px-4 py-2 bg-custom-secondary-blue text-white rounded-md hover:bg-custom-secondary-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile,
            sendEmailVerification,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            collection,
            query,
            where,
            addDoc,
            getDocs,
            serverTimestamp,
            orderBy,
            arrayUnion, // Import arrayUnion
            arrayRemove // Import arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Configuration (REPLACE WITH YOUR ACTUAL CONFIG) ---
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        const storage = getStorage(app);

        // --- Global Variables ---
        let currentUserId = null;
        let currentUserEmail = null;
        let userDisplayName = null;
        let userProfilePicUrl = "https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF"; // Default profile picture
        let activeChat = null; // { type: 'contact' | 'group', id: 'uid' | 'groupId', name: '...' }
        let contacts = [];
        let groups = [];
        let friendRequests = []; // To store incoming friend requests
        let unsubscribeMessages = null;
        let unsubscribeContacts = null;
        let unsubscribeGroups = null;
        let unsubscribeFriendRequests = null;
        let notifications = [];
        let notificationIdCounter = 0;
        let resendEmailTimer = null;
        let resendEmailCooldown = 60; // seconds

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const toggleAuthButton = document.getElementById('toggle-auth');
        const registerFields = document.getElementById('register-fields');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const usernameInput = document.getElementById('username');
        const phoneInput = document.getElementById('phone');
        const dobInput = document.getElementById('dob');
        const ageInput = document.getElementById('age');
        const authMessage = document.getElementById('auth-message');
        const logoutButton = document.getElementById('logout-button');
        const mobileLogoutButton = document.getElementById('mobile-logout-button');
        const userDisplayUsernameElement = document.getElementById('user-display-username');
        const userPhoneDisplay = document.getElementById('user-phone-display');
        const userDobDisplay = document.getElementById('user-dob-display');
        const userAgeDisplay = document.getElementById('user-age-display');
        const profilePicElement = document.getElementById('profile-pic');
        const profilePicUploadInput = document.getElementById('profile-pic-upload');
        const uploadPicButton = document.getElementById('upload-pic-button');
        const emailVerificationStatusSidebar = document.getElementById('email-verification-status-sidebar');
        const emailVerifiedText = document.getElementById('email-verified-text');
        const resendVerificationEmailSidebar = document.getElementById('resend-verification-email-sidebar');
        const changeUsernameButton = document.getElementById('change-username-button');
        const changeUsernameModal = document.getElementById('change-username-modal');
        const cancelChangeUsernameButton = document.getElementById('cancel-change-username');
        const changeUsernameForm = document.getElementById('change-username-form');
        const newUsernameInput = document.getElementById('new-username-input');
        const changeUsernameMessage = document.getElementById('change-username-message');
        const themeToggleButton = document.getElementById('theme-toggle-button');

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
        const closeSidebarButton = document.getElementById('close-sidebar-button');

        const showContactsButton = document.getElementById('show-contacts');
        const showGroupsButton = document.getElementById('show-groups');
        const showNotificationsButton = document.getElementById('show-notifications-button');
        const notificationBadge = document.getElementById('notification-badge');
        const showFriendRequestsButton = document.getElementById('show-friend-requests-button');
        const friendRequestBadge = document.getElementById('friend-request-badge'); // New badge for friend requests

        const chatHeader = document.getElementById('chat-header');
        const currentChatPic = document.getElementById('current-chat-pic');
        const currentChatName = document.getElementById('current-chat-name');
        const currentChatStatus = document.getElementById('current-chat-status');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const messageInputArea = document.getElementById('message-input-area');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const noChatSelected = document.getElementById('no-chat-selected');

        const contactsListView = document.getElementById('contacts-list-view');
        const contactsList = document.getElementById('contacts-list');
        const noContactsMessage = document.getElementById('no-contacts-message');
        const groupsListView = document.getElementById('groups-list-view');
        const groupsList = document.getElementById('groups-list');
        const noGroupsMessage = document.getElementById('no-groups-message');
        const friendRequestsListView = document.getElementById('friend-requests-list-view'); // New element
        const friendRequestsList = document.getElementById('friend-requests-list'); // New element
        const noFriendRequestsMessage = document.getElementById('no-friend-requests-message'); // New element

        const addContactButton = document.getElementById('add-contact-button');
        const addContactModal = document.getElementById('add-contact-modal');
        const cancelAddContactButton = document.getElementById('cancel-add-contact');
        const addContactForm = document.getElementById('add-contact-form');
        const contactInput = document.getElementById('contact-input');
        const addContactMessage = document.getElementById('add-contact-message');

        const createGroupButton = document.getElementById('create-group-button');
        const createGroupModal = document.getElementById('create-group-modal');
        const cancelCreateGroupButton = document.getElementById('cancel-create-group');
        const createGroupForm = document.getElementById('create-group-form');
        const groupNameInput = document.getElementById('group-name');
        const groupDescriptionInput = document.getElementById('group-description');
        const groupPhotoUploadInput = document.getElementById('group-photo-upload');
        const uploadGroupPicButton = document.getElementById('upload-group-pic-button');
        const groupPhotoPreview = document.getElementById('group-photo-preview');
        const groupMemberSelection = document.getElementById('group-member-selection');
        const noContactsForGroupMessage = document.getElementById('no-contacts-for-group');
        const createGroupMessage = document.getElementById('create-group-message');

        const addGroupMemberButton = document.getElementById('add-group-member-button');
        const addGroupMemberModal = document.getElementById('add-group-member-modal');
        const cancelAddGroupMemberButton = document.getElementById('cancel-add-group-member');
        const addGroupMemberForm = document.getElementById('add-group-member-form');
        const addGroupMemberInput = document.getElementById('add-group-member-input');
        const addGroupMemberMessage = document.getElementById('add-group-member-message');
        const leaveGroupButton = document.getElementById('leave-group-button');

        const attachMediaButton = document.getElementById('attach-media-button');
        const chatMediaUploadInput = document.getElementById('chat-media-upload');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalContent = document.getElementById('confirm-modal-content');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalOk = document.getElementById('confirm-modal-ok');

        const messageBox = document.getElementById('message-box');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxOk = document.getElementById('message-box-ok');

        const emailSentModal = document.getElementById('email-sent-modal');
        const emailSentOk = document.getElementById('email-sent-ok');

        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const cancelForgotPassword = document.getElementById('cancel-forgot-password');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const forgotEmailInput = document.getElementById('forgot-email');
        const forgotPasswordMessage = document.getElementById('forgot-password-message');

        const notificationsModal = document.getElementById('notifications-modal');
        const notificationsList = document.getElementById('notifications-list');
        const noNotificationsMessage = document.getElementById('no-notifications-message');
        const clearNotificationsButton = document.getElementById('clear-notifications-button');
        const closeNotificationsModal = document.getElementById('close-notifications-modal');


        // --- Utility Functions ---

        function showMessageBox(title, content, type = 'info') {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            // Optionally change color based on type (info, success, error)
            messageBoxTitle.className = 'text-xl font-bold mb-4 ' + (type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-800');
            messageBoxOk.className = 'px-6 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 ' + (type === 'error' ? 'bg-red-500 hover:bg-red-700 focus:ring-red-500' : type === 'success' ? 'bg-green-500 hover:bg-green-700 focus:ring-green-500' : 'bg-custom-secondary-blue hover:bg-custom-secondary-blue-dark focus:ring-custom-secondary-blue');
            messageBox.classList.remove('hidden');
        }

        messageBoxOk.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });


        function addNotification(title, message, type = 'info') {
            const id = notificationIdCounter++;
            const timestamp = new Date().toLocaleString();
            notifications.unshift({ id, title, message, type, timestamp });
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.length; // Assuming all are 'new' until dismissed or modal closed
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }
        }

        function displayNotifications() {
            notificationsList.innerHTML = '';
            if (notifications.length === 0) {
                noNotificationsMessage.classList.remove('hidden');
                notificationsList.classList.add('hidden');
            } else {
                noNotificationsMessage.classList.add('hidden');
                notificationsList.classList.remove('hidden');
                notifications.forEach(notification => {
                    const li = document.createElement('li');
                    li.className = `p-3 rounded-md shadow-sm border-l-4 ${notification.type === 'error' ? 'bg-red-50 border-red-500' : notification.type === 'success' ? 'bg-green-50 border-green-500' : 'bg-blue-50 border-custom-secondary-blue'}`;
                    li.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-semibold text-gray-800">${notification.title}</h4>
                            <span class="text-xs text-gray-500">${notification.timestamp}</span>
                        </div>
                        <p class="text-sm text-gray-700">${notification.message}</p>
                    `;
                    notificationsList.appendChild(li);
                });
            }
            notificationsModal.classList.remove('hidden');
        }

        clearNotificationsButton.addEventListener('click', () => {
            notifications = [];
            updateNotificationBadge();
            displayNotifications(); // Re-render to show no notifications message
            addNotification('Notificaciones Borradas', 'Todas las notificaciones han sido eliminadas.', 'info');
        });

        closeNotificationsModal.addEventListener('click', () => {
            notificationsModal.classList.add('hidden');
        });

        // --- Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;

                // Load user data from Firestore
                const userDocRef = doc(db, "users", currentUserId);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists()) {
                    // New user, create document with initial data
                    await setDoc(userDocRef, {
                        email: user.email,
                        username: user.email.split('@')[0], // Default username
                        profilePicUrl: userProfilePicUrl,
                        phone: '',
                        dob: '',
                        age: null,
                        emailVerified: user.emailVerified,
                        contacts: [], // Initialize empty contacts array
                        friendRequestsSent: [], // Initialize empty sent requests array
                        friendRequestsReceived: [], // Initialize empty received requests array
                        createdAt: serverTimestamp()
                    });
                    userDisplayName = user.email.split('@')[0];
                    addNotification('Bienvenido', `Tu cuenta ha sido creada. ¡Empieza a chatear!`, 'success');
                } else {
                    const userData = userDocSnap.data();
                    userDisplayName = userData.username || user.email.split('@')[0];
                    userProfilePicUrl = userData.profilePicUrl || userProfilePicUrl;
                    userPhoneDisplay.textContent = userData.phone || 'N/A';
                    userDobDisplay.textContent = userData.dob || 'N/A';
                    userAgeDisplay.textContent = userData.age ? `${userData.age} años` : 'N/A';
                }

                userDisplayUsernameElement.textContent = userDisplayName;
                profilePicElement.src = userProfilePicUrl;

                // Update email verification status
                updateEmailVerificationStatus(user);

                authSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                sidebar.classList.remove('-translate-x-full', 'md:translate-x-0'); // Ensure sidebar is visible on desktop
                sidebarOverlay.classList.add('hidden'); // Hide overlay

                // Start listening for contacts and friend requests
                if (unsubscribeContacts) unsubscribeContacts(); // Unsubscribe previous listener if exists
                listenForContacts(currentUserId);
                if (unsubscribeFriendRequests) unsubscribeFriendRequests(); // Unsubscribe previous listener if exists
                listenForFriendRequests(currentUserId);

                // Start listening for groups
                if (unsubscribeGroups) unsubscribeGroups();
                listenForGroups(currentUserId);

                // Show contacts list by default
                showView('contacts-list-view');

            } else {
                currentUserId = null;
                currentUserEmail = null;
                userDisplayName = null;
                activeChat = null;
                contacts = [];
                groups = [];
                friendRequests = [];
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeContacts) unsubscribeContacts();
                if (unsubscribeGroups) unsubscribeGroups();
                if (unsubscribeFriendRequests) unsubscribeFriendRequests();
                authSection.classList.remove('hidden');
                appSection.classList.add('hidden');
                // Reset auth form to login view on logout
                showLoginView();
            }
        });

        // --- Auth Forms & Logic ---
        let isLogin = true;

        function showLoginView() {
            authTitle.textContent = 'Iniciar Sesión';
            authButton.textContent = 'Iniciar Sesión';
            toggleAuthButton.textContent = 'Regístrate';
            registerFields.classList.add('hidden');
            authMessage.textContent = '';
            isLogin = true;
        }

        function showRegisterView() {
            authTitle.textContent = 'Registrarse';
            authButton.textContent = 'Registrarse';
            toggleAuthButton.textContent = 'Iniciar Sesión';
            registerFields.classList.remove('hidden');
            authMessage.textContent = '';
            isLogin = false;
        }

        toggleAuthButton.addEventListener('click', () => {
            if (isLogin) {
                showRegisterView();
            } else {
                showLoginView();
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            authMessage.textContent = '';

            if (isLogin) {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    addNotification('Inicio de Sesión Exitoso', `Bienvenido de nuevo, ${auth.currentUser.displayName || auth.currentUser.email}.`, 'success');
                } catch (error) {
                    console.error("Error al iniciar sesión:", error);
                    let errorMessage = "Error al iniciar sesión. Por favor, verifica tus credenciales.";
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "No hay usuario con ese correo electrónico.";
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = "Contraseña incorrecta.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Correo electrónico no válido.";
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = "Demasiados intentos fallidos. Inténtalo de nuevo más tarde.";
                    }
                    authMessage.textContent = errorMessage;
                    addNotification('Error de Autenticación', errorMessage, 'error');
                }
            } else {
                const username = usernameInput.value || email.split('@')[0];
                const phone = phoneInput.value;
                const dob = dobInput.value;
                const age = ageInput.value ? parseInt(ageInput.value) : null;

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    await setDoc(doc(db, "users", user.uid), {
                        email: user.email,
                        username: username,
                        profilePicUrl: userProfilePicUrl, // Default profile picture
                        phone: phone,
                        dob: dob,
                        age: age,
                        emailVerified: user.emailVerified,
                        contacts: [], // Important: initialize as empty array
                        friendRequestsSent: [],
                        friendRequestsReceived: [],
                        createdAt: serverTimestamp()
                    });

                    // Update Auth profile
                    await updateProfile(user, {
                        displayName: username,
                        photoURL: userProfilePicUrl
                    });

                    // Send verification email
                    await sendEmailVerification(user);
                    emailSentModal.classList.remove('hidden');
                    addNotification('Registro Exitoso', `Cuenta creada para ${username}. Por favor, verifica tu correo electrónico.`, 'success');

                } catch (error) {
                    console.error("Error al registrarse:", error);
                    let errorMessage = "Error al registrarse.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "El correo electrónico ya está en uso.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "La contraseña es demasiado débil (mínimo 6 caracteres).";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Correo electrónico no válido.";
                    }
                    authMessage.textContent = errorMessage;
                    addNotification('Error de Registro', errorMessage, 'error');
                }
            }
        });

        emailSentOk.addEventListener('click', () => {
            emailSentModal.classList.add('hidden');
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                addNotification('Sesión Cerrada', 'Has cerrado sesión correctamente.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                addNotification('Error al Cerrar Sesión', 'No se pudo cerrar sesión. Inténtalo de nuevo.', 'error');
            }
        });

        mobileLogoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                addNotification('Sesión Cerrada', 'Has cerrado sesión correctamente.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                addNotification('Error al Cerrar Sesión', 'No se pudo cerrar sesión. Inténtalo de nuevo.', 'error');
            }
        });


        // --- Profile Management ---
        uploadPicButton.addEventListener('click', () => {
            profilePicUploadInput.click();
        });

        profilePicUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                addNotification('Error de Subida', 'El archivo es demasiado grande (máximo 5MB).', 'error');
                return;
            }

            try {
                const storageRef = ref(storage, `profile_pics/${currentUserId}/${file.name}`);
                await uploadBytes(storageRef, file);
                const photoURL = await getDownloadURL(storageRef);

                await updateDoc(doc(db, "users", currentUserId), {
                    profilePicUrl: photoURL
                });

                await updateProfile(auth.currentUser, {
                    photoURL: photoURL
                });

                profilePicElement.src = photoURL;
                addNotification('Foto Actualizada', 'Tu foto de perfil ha sido actualizada.', 'success');
            } catch (error) {
                console.error("Error al subir foto de perfil:", error);
                addNotification('Error de Subida', 'Hubo un error al subir la foto de perfil.', 'error');
            }
        });

        changeUsernameButton.addEventListener('click', () => {
            newUsernameInput.value = userDisplayName;
            changeUsernameMessage.textContent = '';
            changeUsernameModal.classList.remove('hidden');
        });

        cancelChangeUsernameButton.addEventListener('click', () => {
            changeUsernameModal.classList.add('hidden');
        });

        changeUsernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = newUsernameInput.value.trim();
            if (!newUsername) {
                changeUsernameMessage.textContent = 'El nombre de usuario no puede estar vacío.';
                return;
            }

            if (newUsername === userDisplayName) {
                changeUsernameMessage.textContent = 'El nuevo nombre de usuario es el mismo que el actual.';
                return;
            }

            try {
                // Check if username already exists
                const q = query(collection(db, "users"), where("username", "==", newUsername));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    changeUsernameMessage.textContent = 'Este nombre de usuario ya está en uso.';
                    addNotification('Error al Cambiar Nombre de Usuario', 'Este nombre de usuario ya está en uso.', 'error');
                    return;
                }

                const userDocRef = doc(db, "users", currentUserId);
                await updateDoc(userDocRef, {
                    username: newUsername
                });

                // Update auth profile
                await updateProfile(auth.currentUser, {
                    displayName: newUsername
                });

                userDisplayName = newUsername;
                userDisplayUsernameElement.textContent = newUsername;
                addNotification('Nombre de Usuario Actualizado', `Tu nombre de usuario se ha cambiado a "${newUsername}" correctamente.`, 'success');
                changeUsernameModal.classList.add('hidden');
            } catch (error) {
                console.error('Error al cambiar nombre de usuario:', error);
                let errorMessage = `Hubo un problema al cambiar el nombre de usuario.`;
                if (error.code === 'permission-denied' || (error.message && error.message.includes('Missing or insufficient permissions'))) {
                    errorMessage = 'No tienes permisos suficientes para cambiar el nombre de usuario. Asegúrate de que las reglas de seguridad de Firestore estén configuradas correctamente.';
                }
                changeUsernameMessage.textContent = errorMessage;
                addNotification('Error al Cambiar Nombre de Usuario', errorMessage, 'error');
            }
        });

        // --- Email Verification ---
        function updateEmailVerificationStatus(user) {
            if (user.emailVerified) {
                emailVerifiedText.textContent = 'Email Verificado';
                emailVerifiedText.className = 'text-xs text-green-600';
                resendVerificationEmailSidebar.classList.add('hidden');
                if (resendEmailTimer) clearInterval(resendEmailTimer);
            } else {
                emailVerifiedText.textContent = 'Email No Verificado';
                emailVerifiedText.className = 'text-xs text-red-600';
                resendVerificationEmailSidebar.classList.remove('hidden');
                startResendEmailCooldown();
            }
        }

        let cooldownRemaining = 0;
        function startResendEmailCooldown() {
            cooldownRemaining = resendEmailCooldown;
            resendVerificationEmailSidebar.disabled = true;
            resendVerificationEmailSidebar.textContent = `Reenviar Email (${cooldownRemaining}s)`;

            resendEmailTimer = setInterval(() => {
                cooldownRemaining--;
                if (cooldownRemaining <= 0) {
                    clearInterval(resendEmailTimer);
                    resendVerificationEmailSidebar.disabled = false;
                    resendVerificationEmailSidebar.textContent = 'Reenviar Email de Verificación';
                } else {
                    resendVerificationEmailSidebar.textContent = `Reenviar Email (${cooldownRemaining}s)`;
                }
            }, 1000);
        }

        resendVerificationEmailSidebar.addEventListener('click', async () => {
            try {
                if (auth.currentUser && !auth.currentUser.emailVerified) {
                    await sendEmailVerification(auth.currentUser);
                    addNotification('Email Enviado', 'Enlace de verificación reenviado. Revisa tu bandeja de entrada.', 'info');
                    startResendEmailCooldown();
                }
            } catch (error) {
                console.error("Error al reenviar email de verificación:", error);
                addNotification('Error al Enviar Email', 'No se pudo reenviar el email de verificación.', 'error');
            }
        });

        // --- Forgot Password Logic ---
        forgotPasswordLink.addEventListener('click', () => {
            forgotPasswordMessage.textContent = '';
            forgotEmailInput.value = '';
            forgotPasswordModal.classList.remove('hidden');
        });

        cancelForgotPassword.addEventListener('click', () => {
            forgotPasswordModal.classList.add('hidden');
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = forgotEmailInput.value;
            forgotPasswordMessage.textContent = '';

            try {
                await sendPasswordResetEmail(auth, email);
                forgotPasswordMessage.textContent = 'Se ha enviado un enlace para restablecer la contraseña a tu correo electrónico.';
                forgotPasswordMessage.className = 'text-sm text-green-600';
                addNotification('Restablecer Contraseña', 'Enlace enviado a tu correo electrónico.', 'success');
                setTimeout(() => forgotPasswordModal.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Error al restablecer contraseña:", error);
                let errorMessage = "Error al enviar el enlace de restablecimiento de contraseña.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No hay usuario registrado con ese correo electrónico.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Correo electrónico no válido.";
                }
                forgotPasswordMessage.textContent = errorMessage;
                forgotPasswordMessage.className = 'text-sm text-red-600';
                addNotification('Error de Restablecimiento', errorMessage, 'error');
            }
        });


        // --- Sidebar Toggles ---
        mobileSidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        });

        closeSidebarButton.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });


        // --- View Management ---
        function hideAllViews() {
            contactsListView.classList.add('hidden');
            groupsListView.classList.add('hidden');
            chatMessagesContainer.classList.add('hidden');
            messageInputArea.classList.add('hidden');
            noChatSelected.classList.add('hidden');
            friendRequestsListView.classList.add('hidden'); // Hide new view
        }

        function showView(viewId) {
            hideAllViews();
            document.getElementById(viewId).classList.remove('hidden');
            // Hide specific elements if a chat is not selected
            if (viewId !== 'chat-messages-container') {
                chatHeader.classList.remove('hidden'); // Ensure header is visible
                currentChatName.textContent = 'Selecciona un chat';
                currentChatStatus.textContent = '';
                currentChatPic.src = "https://placehold.co/50x50/E2E8F0/4A5568?text=Chat";
                addGroupMemberButton.classList.add('hidden');
                leaveGroupButton.classList.add('hidden');
                activeChat = null;
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                    unsubscribeMessages = null;
                }
            }
            // Close sidebar on mobile after view selection
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }

        showContactsButton.addEventListener('click', () => showView('contacts-list-view'));
        showGroupsButton.addEventListener('click', () => showView('groups-list-view'));
        showNotificationsButton.addEventListener('click', displayNotifications);
        showFriendRequestsButton.addEventListener('click', () => showView('friend-requests-list-view')); // New event listener

        // --- Contact Management ---

        // Listen for accepted contacts
        async function listenForContacts(userId) {
            if (unsubscribeContacts) unsubscribeContacts(); // Unsubscribe from previous listener

            const userDocRef = doc(db, "users", userId);

            unsubscribeContacts = onSnapshot(userDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const contactUids = userData.contacts || [];
                    contacts = []; // Clear current contacts list

                    if (contactUids.length > 0) {
                        const contactPromises = contactUids.map(uid => getDoc(doc(db, "users", uid)));
                        const contactSnaps = await Promise.all(contactPromises);

                        contactSnaps.forEach(contactSnap => {
                            if (contactSnap.exists()) {
                                const contactData = contactSnap.data();
                                contacts.push({
                                    id: contactSnap.id,
                                    email: contactData.email,
                                    username: contactData.username,
                                    profilePicUrl: contactData.profilePicUrl || "https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF"
                                });
                            }
                        });
                        contactsList.innerHTML = ''; // Clear existing display
                        contacts.forEach(contact => {
                            const li = document.createElement('li');
                            li.className = 'flex items-center p-3 rounded-md hover:bg-gray-200 transition-colors duration-200 cursor-pointer';
                            li.innerHTML = `
                                <img src="${contact.profilePicUrl}" alt="${contact.username}" class="w-10 h-10 rounded-full object-cover mr-3">
                                <div>
                                    <p class="font-medium text-gray-800">${contact.username}</p>
                                    <p class="text-sm text-gray-500">${contact.email}</p>
                                </div>
                            `;
                            li.addEventListener('click', () => startChatWithContact(contact));
                            contactsList.appendChild(li);
                        });
                        noContactsMessage.classList.add('hidden');
                    } else {
                        contactsList.innerHTML = '';
                        noContactsMessage.classList.remove('hidden');
                    }
                }
            }, (error) => {
                console.error("Error listening for contacts:", error);
                addNotification('Error de Contactos', 'No se pudieron cargar tus contactos.', 'error');
            });
        }


        // New: Listen for incoming friend requests
        async function listenForFriendRequests(userId) {
            if (unsubscribeFriendRequests) unsubscribeFriendRequests();

            const userDocRef = doc(db, "users", userId);

            unsubscribeFriendRequests = onSnapshot(userDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const incomingRequestUids = userData.friendRequestsReceived || [];
                    friendRequests = []; // Clear current requests list

                    if (incomingRequestUids.length > 0) {
                        const requestPromises = incomingRequestUids.map(uid => getDoc(doc(db, "users", uid)));
                        const requestSnaps = await Promise.all(requestPromises);

                        requestSnaps.forEach(requestSnap => {
                            if (requestSnap.exists()) {
                                const requestorData = requestSnap.data();
                                friendRequests.push({
                                    id: requestSnap.id,
                                    email: requestorData.email,
                                    username: requestorData.username,
                                    profilePicUrl: requestorData.profilePicUrl || "https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF"
                                });
                            }
                        });
                        displayFriendRequests();
                    } else {
                        displayFriendRequests(); // Call to update display to empty state
                    }
                    updateFriendRequestBadge();
                }
            }, (error) => {
                console.error("Error listening for friend requests:", error);
                addNotification('Error de Solicitudes', 'No se pudieron cargar tus solicitudes de amistad.', 'error');
            });
        }

        function displayFriendRequests() {
            friendRequestsList.innerHTML = '';
            if (friendRequests.length === 0) {
                noFriendRequestsMessage.classList.remove('hidden');
                friendRequestsList.classList.add('hidden');
            } else {
                noFriendRequestsMessage.classList.add('hidden');
                friendRequestsList.classList.remove('hidden');
                friendRequests.forEach(requestor => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-3 rounded-md bg-white shadow-sm border border-gray-200';
                    li.innerHTML = `
                        <div class="flex items-center">
                            <img src="${requestor.profilePicUrl}" alt="${requestor.username}" class="w-10 h-10 rounded-full object-cover mr-3">
                            <div>
                                <p class="font-medium text-gray-800">${requestor.username}</p>
                                <p class="text-sm text-gray-500">${requestor.email} te ha enviado una solicitud.</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="accept-request-btn px-3 py-1 bg-green-500 text-white text-sm rounded-md hover:bg-green-600 transition-colors" data-uid="${requestor.id}">Aceptar</button>
                            <button class="reject-request-btn px-3 py-1 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition-colors" data-uid="${requestor.id}">Rechazar</button>
                        </div>
                    `;
                    friendRequestsList.appendChild(li);
                });

                // Add event listeners to the new buttons
                friendRequestsList.querySelectorAll('.accept-request-btn').forEach(button => {
                    button.addEventListener('click', (e) => acceptFriendRequest(e.target.dataset.uid));
                });
                friendRequestsList.querySelectorAll('.reject-request-btn').forEach(button => {
                    button.addEventListener('click', (e) => rejectFriendRequest(e.target.dataset.uid));
                });
            }
        }

        function updateFriendRequestBadge() {
            const count = friendRequests.length;
            if (count > 0) {
                friendRequestBadge.textContent = count;
                friendRequestBadge.classList.remove('hidden');
            } else {
                friendRequestBadge.classList.add('hidden');
            }
        }

        async function acceptFriendRequest(requestorId) {
            try {
                // Remove from current user's received requests and add to contacts
                const currentUserRef = doc(db, "users", currentUserId);
                await updateDoc(currentUserRef, {
                    friendRequestsReceived: arrayRemove(requestorId),
                    contacts: arrayUnion(requestorId)
                });

                // Remove from requestor's sent requests and add to their contacts
                const requestorRef = doc(db, "users", requestorId);
                await updateDoc(requestorRef, {
                    friendRequestsSent: arrayRemove(currentUserId),
                    contacts: arrayUnion(currentUserId)
                });

                addNotification('Solicitud Aceptada', `Ahora eres amigo de ${friendRequests.find(r => r.id === requestorId)?.username || 'un usuario'}.`, 'success');
                // Re-fetch contacts and requests to update UI
                listenForContacts(currentUserId);
                listenForFriendRequests(currentUserId);
            } catch (error) {
                console.error("Error accepting friend request:", error);
                addNotification('Error', 'No se pudo aceptar la solicitud de amistad.', 'error');
            }
        }

        async function rejectFriendRequest(requestorId) {
            try {
                // Remove from current user's received requests
                const currentUserRef = doc(db, "users", currentUserId);
                await updateDoc(currentUserRef, {
                    friendRequestsReceived: arrayRemove(requestorId)
                });

                // Remove from requestor's sent requests
                const requestorRef = doc(db, "users", requestorId);
                await updateDoc(requestorRef, {
                    friendRequestsSent: arrayRemove(currentUserId)
                });

                addNotification('Solicitud Rechazada', `Has rechazado la solicitud de amistad.`, 'info');
                // Re-fetch requests to update UI
                listenForFriendRequests(currentUserId);
            } catch (error) {
                console.error("Error rejecting friend request:", error);
                addNotification('Error', 'No se pudo rechazar la solicitud de amistad.', 'error');
            }
        }


        addContactButton.addEventListener('click', () => {
            addContactMessage.textContent = '';
            contactInput.value = '';
            addContactModal.classList.remove('hidden');
        });

        cancelAddContactButton.addEventListener('click', () => {
            addContactModal.classList.add('hidden');
        });

        addContactForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = contactInput.value.trim();
            addContactMessage.textContent = '';

            if (!identifier) {
                addContactMessage.textContent = 'Por favor, introduce un correo electrónico o nombre de usuario.';
                return;
            }

            if (identifier === currentUserEmail || identifier === userDisplayName) {
                addContactMessage.textContent = 'No puedes añadirte a ti mismo.';
                return;
            }

            try {
                // Find target user by email or username
                let targetUserQuery;
                if (identifier.includes('@')) {
                    targetUserQuery = query(collection(db, "users"), where("email", "==", identifier));
                } else {
                    targetUserQuery = query(collection(db, "users"), where("username", "==", identifier));
                }

                const querySnapshot = await getDocs(targetUserQuery);

                if (querySnapshot.empty) {
                    addContactMessage.textContent = 'Usuario no encontrado.';
                    addNotification('Error', 'Usuario no encontrado.', 'error');
                    return;
                }

                const targetUserDoc = querySnapshot.docs[0];
                const targetUserId = targetUserDoc.id;
                const targetUserData = targetUserDoc.data();

                // Check if already contacts
                if (contacts.some(c => c.id === targetUserId)) {
                    addContactMessage.textContent = `${targetUserData.username} ya es uno de tus contactos.`;
                    addNotification('Info', `${targetUserData.username} ya es uno de tus contactos.`, 'info');
                    return;
                }

                // Check if a request is already pending (sent by current user)
                if (targetUserData.friendRequestsReceived && targetUserData.friendRequestsReceived.includes(currentUserId)) {
                     addContactMessage.textContent = `Ya has enviado una solicitud a ${targetUserData.username}.`;
                     addNotification('Info', `Ya has enviado una solicitud a ${targetUserData.username}.`, 'info');
                     return;
                }

                // Check if a request is already pending (sent by target user to current user)
                // This means the target user has sent a request to you, which you should accept/reject
                const currentUserDoc = await getDoc(doc(db, "users", currentUserId));
                const currentUserData = currentUserDoc.data();
                if (currentUserData.friendRequestsReceived && currentUserData.friendRequestsReceived.includes(targetUserId)) {
                    addContactMessage.textContent = `${targetUserData.username} ya te ha enviado una solicitud. Puedes aceptarla en la sección de "Solicitudes".`;
                    addNotification('Info', `${targetUserData.username} ya te ha enviado una solicitud. Puedes aceptarla en la sección de "Solicitudes".`, 'info');
                    return;
                }


                // Send friend request
                const currentUserRef = doc(db, "users", currentUserId);
                const targetUserRef = doc(db, "users", targetUserId);

                await updateDoc(currentUserRef, {
                    friendRequestsSent: arrayUnion(targetUserId)
                });
                await updateDoc(targetUserRef, {
                    friendRequestsReceived: arrayUnion(currentUserId)
                });

                addContactMessage.textContent = `Solicitud de amistad enviada a ${targetUserData.username}.`;
                addContactMessage.className = 'text-sm text-green-600';
                addNotification('Solicitud Enviada', `Has enviado una solicitud a ${targetUserData.username}.`, 'success');

                setTimeout(() => addContactModal.classList.add('hidden'), 2000);

            } catch (error) {
                console.error("Error al añadir contacto:", error);
                addContactMessage.textContent = 'Hubo un error al enviar la solicitud.';
                addNotification('Error', 'Hubo un error al enviar la solicitud de amistad.', 'error');
            }
        });


        // --- Chat Functionality ---
        function startChatWithContact(contact) {
            showView('chat-messages-container');
            activeChat = { type: 'contact', id: contact.id, name: contact.username, pic: contact.profilePicUrl };
            currentChatName.textContent = contact.username;
            currentChatPic.src = contact.profilePicUrl;
            currentChatStatus.textContent = 'Online'; // Or fetch actual status
            messageInputArea.classList.remove('hidden');
            addGroupMemberButton.classList.add('hidden'); // Hide group specific buttons
            leaveGroupButton.classList.add('hidden');
            listenForMessages();
        }

        function startChatWithGroup(group) {
            showView('chat-messages-container');
            activeChat = { type: 'group', id: group.id, name: group.name, pic: group.photoURL, adminId: group.adminId, members: group.members };
            currentChatName.textContent = group.name;
            currentChatPic.src = group.photoURL;
            currentChatStatus.textContent = `${group.members.length} miembros`; // Show member count
            messageInputArea.classList.remove('hidden');

            // Show/hide group specific buttons based on admin status
            if (group.adminId === currentUserId) {
                addGroupMemberButton.classList.remove('hidden');
            } else {
                addGroupMemberButton.classList.add('hidden');
            }
            leaveGroupButton.classList.remove('hidden'); // Always show leave button for groups

            listenForMessages();
        }

        async function listenForMessages() {
            if (unsubscribeMessages) unsubscribeMessages(); // Stop previous listener

            chatMessagesContainer.innerHTML = ''; // Clear existing messages
            const messagesCollectionRef = collection(db, "messages");
            let q;

            if (activeChat.type === 'contact') {
                // For direct messages, query messages between the two users
                q = query(messagesCollectionRef,
                    where("chatType", "==", "private"),
                    where("participants", "array-contains", currentUserId),
                    orderBy("timestamp", "asc")
                );
            } else if (activeChat.type === 'group') {
                // For group messages, query messages belonging to the group
                q = query(messagesCollectionRef,
                    where("chatType", "==", "group"),
                    where("groupId", "==", activeChat.id),
                    orderBy("timestamp", "asc")
                );
            } else {
                console.warn("No active chat selected.");
                return;
            }

            unsubscribeMessages = onSnapshot(q, async (snapshot) => {
                // Process only changes that are new messages
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === "added") {
                        const message = change.doc.data();
                        const messageId = change.doc.id;

                        // Filter messages for direct chats
                        if (activeChat.type === 'contact') {
                            const participants = message.participants || [];
                            const isForThisChat = (participants.includes(currentUserId) && participants.includes(activeChat.id));
                            if (!isForThisChat) {
                                return; // Skip messages not for this specific private chat
                            }
                        }
                        displayMessage(message, messageId);
                    }
                });
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
            }, (error) => {
                console.error("Error listening for messages:", error);
                addNotification('Error de Mensajes', 'No se pudieron cargar los mensajes.', 'error');
            });
        }


        // Function to display a single message
        async function displayMessage(message, messageId) {
            const messageElement = document.createElement('div');
            const isSelf = message.senderId === currentUserId;
            const senderInfo = await getUserInfo(message.senderId);
            const senderName = senderInfo ? senderInfo.username : 'Usuario Desconocido';
            const senderPic = senderInfo ? senderInfo.profilePicUrl : 'https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF';

            let mediaContent = '';
            if (message.mediaUrl) {
                if (message.mediaType && message.mediaType.startsWith('image/')) {
                    mediaContent = `<img src="${message.mediaUrl}" alt="Media" class="max-w-xs rounded-lg mt-2 cursor-pointer" onclick="window.open('${message.mediaUrl}', '_blank');">`;
                } else if (message.mediaType && message.mediaType.startsWith('video/')) {
                    mediaContent = `<video controls src="${message.mediaUrl}" class="max-w-xs rounded-lg mt-2" onclick="this.play();"></video>`;
                }
            }

            messageElement.classList.add('message-container', isSelf ? 'self' : 'other');

            messageElement.innerHTML = `
                <img src="${senderPic}" alt="${senderName}" class="message-avatar">
                <div class="message-bubble ${isSelf ? 'self' : 'other'}">
                    ${!isSelf ? `<p class="message-sender">${senderName}</p>` : ''}
                    <p class="message-content">${message.text}</p>
                    ${mediaContent}
                    <p class="message-timestamp">${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Ahora'}</p>
                </div>
            `;
            chatMessagesContainer.appendChild(messageElement);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }


        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const text = messageInput.value.trim();
            const mediaFile = chatMediaUploadInput.files[0];

            if (!activeChat) {
                addNotification('Error', 'Selecciona un chat para enviar un mensaje.', 'error');
                return;
            }
            if (!text && !mediaFile) {
                return; // Don't send empty messages
            }

            try {
                let mediaUrl = '';
                let mediaType = '';

                if (mediaFile) {
                    if (mediaFile.size > 20 * 1024 * 1024) { // 20MB limit for media
                        addNotification('Error de Subida', 'El archivo multimedia es demasiado grande (máximo 20MB).', 'error');
                        return;
                    }
                    const mediaRef = ref(storage, `chat_media/${currentUserId}/${Date.now()}_${mediaFile.name}`);
                    await uploadBytes(mediaRef, mediaFile);
                    mediaUrl = await getDownloadURL(mediaRef);
                    mediaType = mediaFile.type;
                }

                const messageData = {
                    senderId: currentUserId,
                    senderName: userDisplayName,
                    text: text,
                    timestamp: serverTimestamp(),
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                };

                if (activeChat.type === 'contact') {
                    // For private chats
                    messageData.chatType = 'private';
                    messageData.participants = [currentUserId, activeChat.id].sort(); // Store sorted for easy querying
                    messageData.receiverId = activeChat.id; // For direct message
                } else if (activeChat.type === 'group') {
                    // For group chats
                    messageData.chatType = 'group';
                    messageData.groupId = activeChat.id;
                }

                await addDoc(collection(db, "messages"), messageData);
                messageInput.value = ''; // Clear input
                chatMediaUploadInput.value = ''; // Clear file input
                addNotification('Mensaje Enviado', 'Tu mensaje ha sido enviado.', 'success');

            } catch (error) {
                console.error("Error sending message:", error);
                addNotification('Error al Enviar', 'Hubo un error al enviar el mensaje.', 'error');
            }
        }

        attachMediaButton.addEventListener('click', () => {
            chatMediaUploadInput.click();
        });


        // --- Group Management ---
        createGroupButton.addEventListener('click', async () => {
            createGroupMessage.textContent = '';
            groupNameInput.value = '';
            groupDescriptionInput.value = '';
            groupPhotoUploadInput.value = ''; // Clear file input
            groupPhotoPreview.src = "https://placehold.co/80x80/E2E8F0/4A5568?text=Grupo"; // Reset preview

            // Populate member selection with current contacts
            groupMemberSelection.innerHTML = '';
            if (contacts.length === 0) {
                noContactsForGroupMessage.classList.remove('hidden');
                groupMemberSelection.classList.add('hidden');
            } else {
                noContactsForGroupMessage.classList.add('hidden');
                groupMemberSelection.classList.remove('hidden');
                contacts.forEach(contact => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2';
                    div.innerHTML = `
                        <input type="checkbox" id="member-${contact.id}" value="${contact.id}" class="form-checkbox h-4 w-4 text-custom-primary rounded">
                        <label for="member-${contact.id}" class="text-sm text-gray-700">${contact.username}</label>
                    `;
                    groupMemberSelection.appendChild(div);
                });
            }
            createGroupModal.classList.remove('hidden');
        });

        cancelCreateGroupButton.addEventListener('click', () => {
            createGroupModal.classList.add('hidden');
        });

        uploadGroupPicButton.addEventListener('click', () => {
            groupPhotoUploadInput.click();
        });

        groupPhotoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    groupPhotoPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                groupPhotoPreview.src = "https://placehold.co/80x80/E2E8F0/4A5568?text=Grupo";
            }
        });

        createGroupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = groupNameInput.value.trim();
            const groupDescription = groupDescriptionInput.value.trim();
            const groupPhotoFile = groupPhotoUploadInput.files[0];
            const selectedMembers = Array.from(groupMemberSelection.querySelectorAll('input[type="checkbox"]:checked'))
                                       .map(cb => cb.value);

            if (!groupName) {
                createGroupMessage.textContent = 'El nombre del grupo es obligatorio.';
                return;
            }

            if (selectedMembers.length === 0) {
                createGroupMessage.textContent = 'Selecciona al menos un miembro para el grupo.';
                return;
            }

            // Add current user to selected members as they are the creator
            if (!selectedMembers.includes(currentUserId)) {
                selectedMembers.push(currentUserId);
            }

            try {
                let groupPhotoURL = "https://placehold.co/80x80/E2E8F0/4A5568?text=Grupo";
                if (groupPhotoFile) {
                    if (groupPhotoFile.size > 5 * 1024 * 1024) { // 5MB limit
                        addNotification('Error de Subida', 'La foto del grupo es demasiado grande (máximo 5MB).', 'error');
                        return;
                    }
                    const storageRef = ref(storage, `group_photos/${Date.now()}_${groupPhotoFile.name}`);
                    await uploadBytes(storageRef, groupPhotoFile);
                    groupPhotoURL = await getDownloadURL(storageRef);
                }

                const newGroupRef = await addDoc(collection(db, "groups"), {
                    name: groupName,
                    description: groupDescription,
                    photoURL: groupPhotoURL,
                    adminId: currentUserId,
                    members: selectedMembers,
                    createdAt: serverTimestamp()
                });

                // Add the group to each member's user document
                await Promise.all(selectedMembers.map(memberId => {
                    const userRef = doc(db, "users", memberId);
                    return updateDoc(userRef, {
                        groups: arrayUnion(newGroupRef.id)
                    });
                }));

                addNotification('Grupo Creado', `El grupo "${groupName}" ha sido creado correctamente.`, 'success');
                createGroupModal.classList.add('hidden');
                listenForGroups(currentUserId); // Refresh groups list
            } catch (error) {
                console.error("Error al crear grupo:", error);
                createGroupMessage.textContent = 'Hubo un error al crear el grupo.';
                addNotification('Error', 'Hubo un error al crear el grupo.', 'error');
            }
        });

        async function listenForGroups(userId) {
            if (unsubscribeGroups) unsubscribeGroups();

            const groupsCollectionRef = collection(db, "groups");
            const q = query(groupsCollectionRef, where("members", "array-contains", userId));

            unsubscribeGroups = onSnapshot(q, (snapshot) => {
                groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                groupsList.innerHTML = '';
                if (groups.length > 0) {
                    groups.forEach(group => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center p-3 rounded-md hover:bg-gray-200 transition-colors duration-200 cursor-pointer';
                        li.innerHTML = `
                            <img src="${group.photoURL}" alt="${group.name}" class="w-10 h-10 rounded-full object-cover mr-3">
                            <div>
                                <p class="font-medium text-gray-800">${group.name}</p>
                                <p class="text-sm text-gray-500">${group.members.length} miembros</p>
                            </div>
                        `;
                        li.addEventListener('click', () => startChatWithGroup(group));
                        groupsList.appendChild(li);
                    });
                    noGroupsMessage.classList.add('hidden');
                } else {
                    noGroupsMessage.classList.remove('hidden');
                }
            }, (error) => {
                console.error("Error listening for groups:", error);
                addNotification('Error de Grupos', 'No se pudieron cargar tus grupos.', 'error');
            });
        }


        addGroupMemberButton.addEventListener('click', () => {
            if (!activeChat || activeChat.type !== 'group') {
                showMessageBox('Error', 'Debes tener un grupo seleccionado para añadir miembros.');
                return;
            }
            if (activeChat.adminId !== currentUserId) {
                showMessageBox('Permiso Denegado', 'Solo el administrador del grupo puede añadir miembros.');
                return;
            }
            if (addGroupMemberModal) addGroupMemberModal.classList.remove('hidden');
            if (addGroupMemberMessage) addGroupMemberMessage.textContent = '';
            if (addGroupMemberInput) addGroupMemberInput.value = '';
        });

        if (cancelAddGroupMemberButton) {
            cancelAddGroupMemberButton.addEventListener('click', () => {
                if (addGroupMemberModal) addGroupMemberModal.classList.add('hidden');
            });
        }

        if (addGroupMemberForm) {
            addGroupMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const memberIdentifier = addGroupMemberInput ? addGroupMemberInput.value.trim() : '';
                if (memberIdentifier) {
                    await addMemberToGroup(memberIdentifier);
                } else {
                    if (addGroupMemberMessage) addGroupMemberMessage.textContent = 'Por favor, introduce el correo electrónico o nombre de usuario del miembro.';
                }
            });
        }

        async function addMemberToGroup(identifier) {
            if (!activeChat || activeChat.type !== 'group' || activeChat.adminId !== currentUserId) {
                addGroupMemberMessage.textContent = 'Operación no permitida.';
                return;
            }

            try {
                // Find target user by email or username
                let targetUserQuery;
                if (identifier.includes('@')) {
                    targetUserQuery = query(collection(db, "users"), where("email", "==", identifier));
                } else {
                    targetUserQuery = query(collection(db, "users"), where("username", "==", identifier));
                }

                const querySnapshot = await getDocs(targetUserQuery);

                if (querySnapshot.empty) {
                    addGroupMemberMessage.textContent = 'Usuario no encontrado.';
                    addNotification('Error', 'Usuario no encontrado para añadir al grupo.', 'error');
                    return;
                }

                const targetUserDoc = querySnapshot.docs[0];
                const targetUserId = targetUserDoc.id;
                const targetUserData = targetUserDoc.data();

                if (activeChat.members.includes(targetUserId)) {
                    addGroupMemberMessage.textContent = `${targetUserData.username} ya es miembro de este grupo.`;
                    addNotification('Info', `${targetUserData.username} ya es miembro del grupo.`, 'info');
                    return;
                }

                // Add member to group's members array
                const groupRef = doc(db, "groups", activeChat.id);
                await updateDoc(groupRef, {
                    members: arrayUnion(targetUserId)
                });

                // Add group to member's groups array
                const memberUserRef = doc(db, "users", targetUserId);
                await updateDoc(memberUserRef, {
                    groups: arrayUnion(activeChat.id)
                });

                addGroupMemberMessage.textContent = `${targetUserData.username} ha sido añadido al grupo.`;
                addGroupMemberMessage.className = 'text-green-600';
                addNotification('Miembro Añadido', `${targetUserData.username} ha sido añadido a "${activeChat.name}".`, 'success');
                if (addGroupMemberModal) addGroupMemberModal.classList.add('hidden');
                listenForGroups(currentUserId); // Refresh group list to update member count
            } catch (error) {
                console.error("Error adding member to group:", error);
                addGroupMemberMessage.textContent = 'Hubo un error al añadir al miembro.';
                addNotification('Error', 'Hubo un error al añadir miembro al grupo.', 'error');
            }
        }

        function leaveGroup() {
            if (!activeChat || activeChat.type !== 'group') {
                showMessageBox('Error', 'No hay un grupo activo para salir.');
                return;
            }

            confirmModalTitle.textContent = 'Salir del Grupo';
            confirmModalContent.textContent = `¿Estás seguro de que quieres salir del grupo "${activeChat.name}"?`;
            confirmModalOk.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors';
            confirmModalOk.onclick = async () => {
                confirmModal.classList.add('hidden');
                try {
                    // Remove user from group's members array
                    const groupRef = doc(db, "groups", activeChat.id);
                    await updateDoc(groupRef, {
                        members: arrayRemove(currentUserId)
                    });

                    // Remove group from user's groups array
                    const userRef = doc(db, "users", currentUserId);
                    await updateDoc(userRef, {
                        groups: arrayRemove(activeChat.id)
                    });

                    // If group admin leaves and there are still members, assign a new admin
                    if (activeChat.adminId === currentUserId && activeChat.members.length > 1) {
                        const remainingMembers = activeChat.members.filter(memberId => memberId !== currentUserId);
                        const newAdminId = remainingMembers[0]; // Assign first remaining member as new admin
                        await updateDoc(groupRef, {
                            adminId: newAdminId
                        });
                        addNotification('Admin de Grupo', `El administrador de "${activeChat.name}" ha cambiado.`, 'info');
                    }
                    // If no members left, you might want to delete the group document entirely
                    // For now, it will just be an empty group.

                    addNotification('Grupo Abandonado', `Has salido del grupo "${activeChat.name}".`, 'success');
                    activeChat = null; // Clear active chat
                    showView('groups-list-view'); // Go back to groups list
                    listenForGroups(currentUserId); // Refresh groups
                } catch (error) {
                    console.error("Error al salir del grupo:", error);
                    addNotification('Error', 'Hubo un error al salir del grupo.', 'error');
                }
            };
            confirmModalCancel.onclick = () => {
                confirmModal.classList.add('hidden');
            };
            confirmModal.classList.remove('hidden');
        }

        if (leaveGroupButton) leaveGroupButton.addEventListener('click', leaveGroup);

        // --- Helper function to get user info (username and profile pic) by UID ---
        // This function will be useful for displaying sender info in messages
        const userInfoCache = {}; // Simple cache to avoid redundant Firestore reads
        async function getUserInfo(uid) {
            if (userInfoCache[uid]) {
                return userInfoCache[uid];
            }
            try {
                const userDocSnap = await getDoc(doc(db, "users", uid));
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const info = {
                        username: userData.username || userData.email.split('@')[0],
                        profilePicUrl: userData.profilePicUrl || "https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF"
                    };
                    userInfoCache[uid] = info; // Cache the result
                    return info;
                }
            } catch (error) {
                console.error("Error getting user info:", error);
            }
            return null; // User not found or error
        }

        // --- Theme Toggle ---
        themeToggleButton.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            themeToggleButton.innerHTML = `<i class="fas ${isDarkMode ? 'fa-moon' : 'fa-sun'} mr-2"></i>Cambiar Tema`;
        });

        // Apply saved theme on load
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleButton.innerHTML = `<i class="fas fa-moon mr-2"></i>Cambiar Tema`;
            } else {
                themeToggleButton.innerHTML = `<i class="fas fa-sun mr-2"></i>Cambiar Tema`;
            }
        })();


    </script>
</body>
</html>
