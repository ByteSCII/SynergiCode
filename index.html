<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynergiCode</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Variables for Theming */
        :root {
            --color-primary: #4CAF50;
            --color-primary-dark: #43A047;
            --color-secondary-blue: #2196F3;
            --color-secondary-blue-dark: #1976D2;
            --color-darkblue: #3B3B6B;
            --color-background: #f0f2f5;
            --color-surface: #ffffff;
            --color-text-default: #374151; /* gray-800 */
            --color-text-secondary: #6B7280; /* gray-500 */
            --color-border: #E5E7EB; /* gray-200 */
            --color-input-border: #D1D5DB; /* gray-300 */
            --color-message-bg-self: var(--color-secondary-blue);
            --color-message-text-self: #ffffff;
            --color-message-bg-other: #e5e7eb; /* gray-200 */
            --color-message-text-other: #374151; /* gray-800 */
            --color-green-status: #22C55E; /* green-500 */
            --color-gray-status: #9CA3AF; /* gray-400 */
            --color-red-error: #EF4444; /* red-600 */
            --color-green-success: #22C55E; /* green-600 */
            --color-blue-info: #3B82F6; /* blue-500 */
        }

        .dark-mode {
            --color-primary: #66BB6A; /* Lighter green for dark mode */
            --color-primary-dark: #81C784;
            --color-secondary-blue: #64B5F6; /* Lighter blue for dark mode */
            --color-secondary-blue-dark: #90CAF9;
            --color-darkblue: #B0BEC5; /* Lighter text for dark mode */
            --color-background: #000000; /* Pure black background */
            --color-surface: #0a0a0a; /* Very dark surface for cards/panels */
            --color-text-default: #E2E8F0; /* Light gray text */
            --color-text-secondary: #A0AEC0; /* Lighter gray secondary text */
            --color-border: #333333; /* Darker border */
            --color-input-border: #444444; /* Darker input border */
            --color-message-bg-self: var(--color-secondary-blue);
            --color-message-text-self: #ffffff;
            --color-message-bg-other: #333333; /* Darker gray for other messages */
            --color-message-text-other: #E2E8F0; /* Light text for other messages */
            --color-green-status: #4CAF50; /* Adjust for dark mode visibility */
            --color-gray-status: #6B7280; /* Adjust for dark mode visibility */
            --color-red-error: #F87171; /* Adjust for dark mode visibility */
            --color-green-success: #4CAF50; /* Adjust for dark mode visibility */
            --color-blue-info: #60A5FA; /* Adjust for dark mode visibility */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-default);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Applying CSS variables to Tailwind-like classes */
        .bg-custom-primary { background-color: var(--color-primary); }
        .hover\:bg-custom-primary-dark:hover { background-color: var(--color-primary-dark); }
        .focus\:ring-custom-primary { --tw-ring-color: var(--color-primary); }

        .text-custom-darkblue { color: var(--color-darkblue); }
        .bg-custom-secondary-blue { background-color: var(--color-secondary-blue); }
        .hover\:bg-custom-secondary-blue-dark:hover { background-color: var(--color-secondary-blue-dark); }
        .focus\:ring-custom-secondary-blue { --tw-ring-color: var(--color-secondary-blue); }

        /* General element styling based on variables */
        .bg-white { background-color: var(--color-surface); }
        .bg-gray-100 { background-color: var(--color-background); } /* Main app background */
        .bg-gray-50 { background-color: var(--color-background); } /* Chat area, lists background */
        .bg-gray-200 { background-color: var(--color-message-bg-other); color: var(--color-message-text-other); } /* Other messages, general gray buttons */
        .hover\:bg-gray-200:hover { background-color: var(--color-border); } /* Hover for lists */
        .hover\:bg-gray-300:hover { background-color: var(--color-border); } /* Hover for buttons */

        .text-gray-700 { color: var(--color-text-default); }
        .text-gray-800 { color: var(--color-text-default); }
        .text-gray-500 { color: var(--color-text-secondary); }
        .text-gray-600 { color: var(--color-text-secondary); }

        .border-gray-200 { border-color: var(--color-border); }
        .border-gray-300 { border-color: var(--color-input-border); }

        .text-red-500 { color: var(--color-red-error); }
        .hover\:text-red-700:hover { color: var(--color-red-error); }
        .text-red-600 { color: var(--color-red-error); }
        .text-green-600 { color: var(--color-green-success); }
        .text-blue-200 { color: var(--color-text-secondary); } /* For sender name in self message */
        .text-blue-300 { color: var(--color-text-secondary); } /* For timestamp in self message */
        .bg-green-500 { background-color: var(--color-green-status); }
        .bg-gray-400 { background-color: var(--color-gray-status); }
        .bg-green-50 { background-color: var(--color-green-success); }
        .bg-red-50 { background-color: var(--color-red-error); }
        .bg-blue-50 { background-color: var(--color-blue-info); }

        /* Custom scrollbar for chat messages */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: var(--color-background);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--color-text-secondary);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--color-darkblue);
        }
        /* Custom modal styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: var(--color-surface);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            color: var(--color-text-default);
        }
        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }

        /* --- NEW/MODIFIED CSS FOR CHAT MESSAGES --- */
        #chat-messages-container {
            padding: 1rem; /* Added padding to the chat container itself */
        }

        .message-container {
            display: flex; /* Use flexbox for message alignment */
            margin-bottom: 0.75rem; /* Space between messages */
            align-items: flex-end; /* Align sender pic/name to bottom of bubble */
            max-width: 100%; /* Ensure container doesn't overflow */
        }

        .message-container.self {
            justify-content: flex-end; /* Align self messages to the right */
        }

        .message-container.other {
            justify-content: flex-start; /* Align other messages to the left */
        }

        .message-avatar {
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            border-radius: 9999px; /* rounded-full */
            object-fit: cover;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .message-container.other .message-avatar {
            margin-right: 0.5rem; /* Space between avatar and message bubble */
        }

        .message-container.self .message-avatar {
            margin-left: 0.5rem; /* Space between message bubble and avatar */
            order: 2; /* Place avatar after message bubble for self messages */
        }

        .message-bubble {
            padding: 0.625rem 1rem; /* py-2.5 px-4, more breathing room inside */
            border-radius: 0.75rem; /* rounded-xl */
            max-width: 70%; /* Limit bubble width to 70% of container */
            word-wrap: break-word; /* Ensure long words break */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* subtle shadow */
            position: relative;
        }

        .message-bubble.self {
            background-color: var(--color-message-bg-self);
            color: var(--color-message-text-self);
            margin-left: auto; /* Push to the right */
            border-bottom-right-radius: 0.25rem; /* Tweak corner for self */
        }

        .message-bubble.other {
            background-color: var(--color-message-bg-other);
            color: var(--color-message-text-other);
            margin-right: auto; /* Push to the left */
            border-bottom-left-radius: 0.25rem; /* Tweak corner for other */
        }

        .message-sender {
            font-weight: 600; /* semibold */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 0.25rem; /* space below sender name */
            color: var(--color-text-default); /* Default for other messages */
        }

        .message-bubble.self .message-sender {
            color: rgba(255, 255, 255, 0.9); /* Lighter sender name for self messages */
        }

        .message-content {
            font-size: 1rem; /* text-base */
            line-height: 1.5;
        }

        .message-timestamp {
            font-size: 0.75rem; /* text-xs */
            color: var(--color-text-secondary);
            text-align: right;
            margin-top: 0.25rem;
            opacity: 0.8;
            line-height: 1; /* Tighter line height for timestamp */
        }

        .message-bubble.self .message-timestamp {
            color: rgba(255, 255, 255, 0.7); /* Lighter timestamp for self messages */
        }
        /* --- END NEW/MODIFIED CSS FOR CHAT MESSAGES --- */

    </style>
</head>
<body class="h-screen flex items-center justify-center">

    <!-- Login/Registration Section -->
    <div id="auth-section" class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
        <div class="flex justify-center mb-6">
            <img src="https://i.imgur.com/CJHtqu5.jpeg" alt="SynergiCode Logo" class="w-48 h-auto">
        </div>
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6" id="auth-title">Iniciar Sesión</h2>
        <form id="auth-form" class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
            </div>
            <!-- New fields for registration -->
            <div id="register-fields" class="space-y-4 hidden">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Nombre de Usuario (opcional)</label>
                    <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Número de Teléfono</label>
                    <input type="tel" id="phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" placeholder="+58XXXXXXXXX" pattern="^\+\d{1,3}\d{7,15}$" title="Formato: +CódigoDePaísNúmero (ej. +584123456789)">
                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                    <input type="date" id="dob" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm">
                </div>
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700">Edad</label>
                    <input type="number" id="age" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" min="0" max="120">
                </div>
            </div>
            <button type="submit" id="auth-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-custom-primary hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">
                Iniciar Sesión
            </button>
        </form>
        <p class="mt-4 text-center text-sm text-gray-600">
            ¿No tienes una cuenta? <button id="toggle-auth" class="font-medium text-custom-secondary-blue hover:text-custom-secondary-blue-dark">Regístrate</button>
        </p>
        <p class="mt-2 text-center text-sm">
            <button id="forgot-password-link" class="font-medium text-custom-secondary-blue hover:text-custom-secondary-blue-dark">¿Olvidaste tu contraseña?</button>
        </p>
        <div id="auth-message" class="mt-4 text-center text-sm text-red-600"></div>
    </div>

    <!-- Main Chat Application Section -->
    <div id="app-section" class="hidden h-screen w-full flex flex-col md:flex-row bg-gray-100 rounded-xl shadow-xl overflow-hidden">
        <!-- Sidebar -->
        <!-- La barra lateral ahora es 'fixed' y 'transform -translate-x-full' por defecto en móvil,
             y 'relative' y 'translate-x-0' en md y superior para que siempre sea visible en PC. -->
        <div id="sidebar" class="w-full max-w-xs md:w-1/4 bg-custom-surface border-r border-gray-200 flex-col md:flex fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-custom-darkblue dark:text-white">SynergiCode</h1>
                <button id="logout-button" class="text-red-500 hover:text-red-700 text-sm font-medium hidden md:block">
                    <i class="fas fa-sign-out-alt mr-1"></i>Salir
                </button>
                <button id="close-sidebar-button" class="md:hidden text-gray-700 hover:text-gray-900 p-2 rounded-md">
                    <i class="fas fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="p-4 flex flex-col items-center border-b border-gray-200">
                <div class="mb-4">
                    <img src="https://i.imgur.com/CJHtqu5.jpeg" alt="SynergiCode Logo" class="w-24 h-auto">
                </div>
                <div class="relative">
                    <img id="profile-pic" src="https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF" alt="Foto de Perfil" class="w-24 h-24 rounded-full object-cover border-2 border-custom-secondary-blue mb-2">
                    <input type="file" id="profile-pic-upload" accept="image/*" class="hidden-file-input">
                    <button id="upload-pic-button" class="absolute bottom-0 right-0 bg-custom-secondary-blue text-white rounded-full p-2 text-xs shadow-md hover:bg-custom-secondary-blue-dark transition-colors duration-200">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <p id="user-display-username" class="text-xl font-bold text-custom-darkblue"></p>

                <!-- Email Verification Status in Sidebar -->
                <div id="email-verification-status-sidebar" class="text-xs text-gray-500 mt-1 text-center">
                    <span id="email-verified-text"></span>
                    <button id="resend-verification-email-sidebar" class="hidden mt-1 text-custom-secondary-blue hover:text-custom-secondary-blue-dark font-medium">
                        Reenviar Email de Verificación
                    </button>
                </div>

                <p id="user-phone-display" class="text-xs text-gray-500"></p>
                <p id="user-dob-display" class="text-xs text-gray-500"></p>
                <p id="user-age-display" class="text-xs text-gray-500"></p>
                <button id="change-username-button" class="mt-4 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    <i class="fas fa-user-edit mr-2"></i>Cambiar Nombre de Usuario
                </button>
                <button id="theme-toggle-button" class="mt-2 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    <i class="fas fa-palette mr-2"></i>Cambiar Tema
                </button>
            </div>
            <div class="p-4 border-t border-gray-200 mt-auto">
                <button id="add-contact-button" class="w-full bg-custom-primary text-white py-2 px-4 rounded-md hover:bg-custom-primary-dark transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">
                    <i class="fas fa-user-plus mr-2"></i>Añadir Contacto
                </button>
                <button id="create-group-button" class="w-full mt-2 bg-custom-primary text-white py-2 px-4 rounded-md hover:bg-custom-primary-dark transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">
                    <i class="fas fa-plus-circle mr-2"></i>Crear Grupo
                </button>
                <button id="mobile-logout-button" class="w-full mt-2 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 md:hidden">
                    <i class="fas fa-sign-out-alt mr-1"></i>Salir
                </button>
            </div>
        </div>

        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>

        <div class="w-full md:w-3/4 flex flex-col">
            <div class="md:hidden p-2 bg-custom-surface border-b border-gray-200 flex justify-between items-center">
                <button id="mobile-sidebar-toggle" class="p-2 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200">
                    <i class="fas fa-bars"></i>
                </button>
                <img src="https://i.imgur.com/CJHtqu5.jpeg" alt="SynergiCode Logo" class="w-12 h-auto">
            </div>

            <nav class="bg-custom-surface p-4 border-b border-gray-200 flex flex-wrap items-center justify-around">
                <button id="show-contacts" class="flex-1 text-center p-3 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 mx-1">
                    <i class="fas fa-address-book mr-2"></i>Contactos
                </button>
                <button id="show-groups" class="flex-1 text-center p-3 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 mx-1">
                    <i class="fas fa-users mr-2"></i>Grupos de Trabajo
                </button>
                <button id="show-notifications-button" class="flex-1 text-center p-3 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 relative mx-1">
                    <i class="fas fa-bell mr-2"></i>Notificaciones
                    <span id="notification-badge" class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
                <button id="show-friend-requests-button" class="flex-1 text-center p-3 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 relative mx-1">
                    <i class="fas fa-user-friends mr-2"></i>Solicitudes
                    <span id="friend-request-badge" class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
            </nav>

            <!-- Header for current chat -->
            <div id="chat-header" class="bg-custom-surface p-4 border-b border-gray-200 flex items-center justify-between">
                <div class="flex items-center">
                    <img id="current-chat-pic" src="https://placehold.co/50x50/E2E8F0/4A5568?text=Chat" alt="Chat Pic" class="w-12 h-12 rounded-full object-cover mr-3">
                    <div>
                        <h2 id="current-chat-name" class="text-xl font-semibold text-gray-800">Selecciona un chat</h2>
                        <p id="current-chat-status" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <!-- Botones de gestión de grupo (añadidos aquí) -->
                <div class="flex space-x-2 ml-auto">
                    <button id="add-group-member-button" class="hidden px-3 py-1 bg-custom-primary text-white text-sm rounded-md hover:bg-custom-primary-dark transition-colors">
                        Añadir Miembro
                    </button>
                    <button id="leave-group-button" class="hidden px-3 py-1 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition-colors">
                        Salir del Grupo
                    </button>
                </div>
            </div>

            <div id="chat-messages-container" class="flex-grow p-4 overflow-y-auto chat-messages bg-gray-50">
                <!-- Messages will be loaded here -->
            </div>

            <div id="message-input-area" class="bg-custom-surface p-4 border-t border-gray-200 flex items-center hidden">
                <input type="file" id="chat-media-upload" accept="image/*,video/*" class="hidden-file-input">
                <button id="attach-media-button" class="mr-3 bg-gray-200 text-gray-700 p-3 rounded-full hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="text" id="message-input" class="flex-grow px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue" placeholder="Escribe un mensaje...">
                <button id="send-message-button" class="ml-3 bg-custom-primary text-white p-3 rounded-full hover:bg-custom-primary-dark transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <div id="no-chat-selected" class="flex-grow flex items-center justify-center text-gray-500 text-lg">
                <p>Selecciona un contacto o grupo para empezar a chatear.</p>
            </div>

            <div id="contacts-list-view" class="flex-grow p-4 overflow-y-auto bg-gray-50 w-full">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Mis Contactos</h3>
                <ul id="contacts-list" class="space-y-2">
                    <!-- Contacts will be loaded here -->
                </ul>
                <p id="no-contacts-message" class="text-center text-gray-500 mt-4 hidden">No tienes contactos. Añade uno para empezar a chatear.</p>
            </div>

            <div id="groups-list-view" class="flex-grow p-4 overflow-y-auto bg-gray-50 w-full hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Mis Grupos de Trabajo</h3>
                <ul id="groups-list" class="space-y-2">
                    <!-- Groups will be loaded here -->
                </ul>
                <p id="no-groups-message" class="text-center text-gray-500 mt-4 hidden">No tienes grupos. Crea uno para empezar a colaborar.</p>
            </div>

            <!-- New Friend Requests View -->
            <div id="friend-requests-list-view" class="flex-grow p-4 overflow-y-auto bg-gray-50 w-full hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Solicitudes de Amistad</h3>
                <ul id="friend-requests-list" class="space-y-2">
                    <!-- Friend requests will be loaded here -->
                </ul>
                <p id="no-friend-requests-message" class="text-center text-gray-500 mt-4 hidden">No tienes solicitudes de amistad.</p>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Añadir Contacto</h3>
            <form id="add-contact-form" class="space-y-4">
                <div>
                    <label for="contact-input" class="block text-sm font-medium text-gray-700">Correo Electrónico o Nombre de Usuario</label>
                    <input type="text" id="contact-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-add-contact" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">Enviar Solicitud</button>
                </div>
                <p id="add-contact-message" class="text-sm text-red-600"></p>
            </form>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="create-group-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Crear Nuevo Grupo de Trabajo</h3>
            <form id="create-group-form" class="space-y-4">
                <div>
                    <label for="group-name" class="block text-sm font-medium text-gray-700">Nombre del Grupo</label>
                    <input type="text" id="group-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
                </div>
                <div>
                    <label for="group-description" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                    <textarea id="group-description" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="group-photo-upload" class="block text-sm font-medium text-gray-700">Foto del Grupo (Opcional)</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <img id="group-photo-preview" src="https://placehold.co/80x80/E2E8F0/4A5568?text=Grupo" alt="Group Photo Preview" class="w-20 h-20 rounded-full object-cover border-2 border-gray-300">
                        <input type="file" id="group-photo-upload" accept="image/*" class="hidden-file-input">
                        <button type="button" id="upload-group-pic-button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                            <i class="fas fa-upload mr-2"></i>Subir Foto
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Miembros (selecciona contactos)</label>
                    <div id="group-member-selection" class="mt-1 border border-gray-300 rounded-md p-2 max-h-40 overflow-y-auto space-y-1">
                        <p id="no-contacts-for-group" class="text-sm text-gray-500 hidden">Añade contactos para poder agregarlos a un grupo.</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-create-group" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">Crear Grupo</button>
                </div>
                <p id="create-group-message" class="text-sm text-red-600"></p>
            </form>
        </div>
    </div>

    <!-- Modal para Añadir Miembro al Grupo -->
    <div id="add-group-member-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4">Añadir Miembro al Grupo</h3>
            <form id="add-group-member-form">
                <div class="mb-4">
                    <label for="add-group-member-input" class="block text-sm font-medium text-gray-700 mb-1">Email o Nombre de Usuario</label>
                    <input type="text" id="add-group-member-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-custom-primary focus:border-custom-primary">
                </div>
                <p id="add-group-member-message" class="text-red-500 text-sm mb-4"></p>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-add-group-member" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark transition-colors">Añadir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="confirm-modal-title" class="text-lg font-semibold mb-4">Confirmación</h3>
            <p id="confirm-modal-content" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button id="confirm-modal-ok" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Message Box for Alerts (kept for critical system messages) -->
    <div id="message-box" class="hidden fixed inset-0 flex items-center justify-center z-[999] modal-overlay">
        <div class="modal-content p-6 w-full max-w-sm text-center">
            <h3 id="message-box-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="message-box-content" class="text-gray-700 mb-6"></p>
            <button id="message-box-ok" class="px-6 py-2 bg-custom-secondary-blue text-white rounded-md hover:bg-custom-secondary-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">OK</button>
        </div>
    </div>

    <!-- Email Sent Modal (kept for registration flow) -->
    <div id="email-sent-modal" class="hidden fixed inset-0 flex items-center justify-center z-[999] modal-overlay">
        <div class="modal-content p-8 w-full max-w-sm text-center">
            <div class="text-custom-primary text-6xl mb-4">
                <i class="fas fa-envelope-circle-check"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">¡Email Enviado!</h3>
            <p class="text-gray-700 mb-6">Por favor, revisa tu bandeja de entrada y haz clic en el enlace de verificación para activar tu cuenta.</p>
            <button id="email-sent-ok" class="px-6 py-2 bg-custom-secondary-blue text-white rounded-md hover:bg-custom-secondary-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Entendido</button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Recuperar Contraseña</h3>
            <form id="forgot-password-form" class="space-y-4">
                <div>
                    <label for="forgot-email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="forgot-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-forgot-password" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">Enviar Enlace</button>
                </div>
                <p id="forgot-password-message" class="text-sm text-red-600"></p>
            </form>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Notificaciones</h3>
            <ul id="notifications-list" class="space-y-3 max-h-80 overflow-y-auto mb-4">
                <!-- Notifications will be loaded here -->
            </ul>
            <p id="no-notifications-message" class="text-center text-gray-500 hidden">No tienes notificaciones nuevas.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="clear-notifications-button" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Borrar Todas</button>
                <button type="button" id="close-notifications-modal" class="px-4 py-2 bg-custom-secondary-blue text-white rounded-md hover:bg-custom-secondary-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Change Username Modal -->
    <div id="change-username-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
        <div class="modal-content p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Cambiar Nombre de Usuario</h3>
            <form id="change-username-form" class="space-y-4">
                <div>
                    <label for="new-username-input" class="block text-sm font-medium text-gray-700">Nuevo Nombre de Usuario</label>
                    <input type="text" id="new-username-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-secondary-blue focus:border-custom-secondary-blue sm:text-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-change-username" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-secondary-blue">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded-md hover:bg-custom-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-primary">Guardar</button>
                </div>
                <p id="change-username-message" class="text-sm text-red-600"></p>
            </form>
        </div>
    </div>


    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile,
            sendEmailVerification,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            collection,
            query,
            where,
            addDoc,
            getDocs,
            serverTimestamp,
            orderBy,
            arrayUnion, // Import arrayUnion
            arrayRemove // Import arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Removed Firebase Storage import as we are using Cloudinary

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyASX4A-fd3tvzWByAkqgdXMB9DbV4r_OLI",
            authDomain: "synergicode.firebaseapp.com",
            projectId: "synergicode",
            storageBucket: "synergicode.firebasestorage.app",
            messagingSenderId: "184895241849",
            appId: "1:184895241849:web:517e25b7535f1530bc9ea8",
            measurementId: "G-Y0CDV2S6XB"
        };

        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = 'dea8gaaek'; // Your Cloudinary Cloud Name
        const CLOUDINARY_UPLOAD_PRESET = 'SynergiCode'; // Your Cloudinary Upload Preset

        // --- Initialize Firebase Services IMMEDIATELY ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // Removed storage initialization as we are using Cloudinary
        console.log("Firebase initialized successfully with provided config.");


        // --- Global Variables ---
        let currentUserId = null;
        let currentUserEmail = null;
        let userDisplayName = null;
        let userProfilePicUrl = "https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF"; // Default profile picture
        let activeChat = null; // { type: 'contact' | 'group', id: 'uid' | 'groupId', name: '...' }
        let contacts = [];
        let groups = [];
        let friendRequests = []; // To store incoming friend requests
        let unsubscribeMessages = null;
        let unsubscribeContacts = null;
        let unsubscribeGroups = null;
        let unsubscribeFriendRequests = null;
        let notifications = [];
        let notificationIdCounter = 0;
        let resendEmailTimer = null;
        let resendEmailCooldown = 60; // seconds


        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const toggleAuthButton = document.getElementById('toggle-auth');
        const registerFields = document.getElementById('register-fields');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const usernameInput = document.getElementById('username');
        const phoneInput = document.getElementById('phone');
        const dobInput = document.getElementById('dob');
        const ageInput = document.getElementById('age');
        const authMessage = document.getElementById('auth-message');
        const logoutButton = document.getElementById('logout-button');
        const mobileLogoutButton = document.getElementById('mobile-logout-button');
        const userDisplayUsernameElement = document.getElementById('user-display-username');
        const userPhoneDisplay = document.getElementById('user-phone-display');
        const userDobDisplay = document.getElementById('user-dob-display');
        const userAgeDisplay = document.getElementById('user-age-display');
        const profilePicElement = document.getElementById('profile-pic');
        const profilePicUploadInput = document.getElementById('profile-pic-upload'); // Corrected line
        const uploadPicButton = document.getElementById('upload-pic-button');
        const emailVerificationStatusSidebar = document.getElementById('email-verification-status-sidebar');
        const emailVerifiedText = document.getElementById('email-verified-text');
        const resendVerificationEmailSidebar = document.getElementById('resend-verification-email-sidebar');
        const changeUsernameButton = document.getElementById('change-username-button');
        const changeUsernameModal = document.getElementById('change-username-modal');
        const cancelChangeUsernameButton = document.getElementById('cancel-change-username');
        const changeUsernameForm = document.getElementById('change-username-form');
        const newUsernameInput = document.getElementById('new-username-input');
        const changeUsernameMessage = document.getElementById('change-username-message');
        const themeToggleButton = document.getElementById('theme-toggle-button');

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
        const closeSidebarButton = document.getElementById('close-sidebar-button');

        const showContactsButton = document.getElementById('show-contacts');
        const showGroupsButton = document.getElementById('show-groups');
        const showNotificationsButton = document.getElementById('show-notifications-button');
        const notificationBadge = document.getElementById('notification-badge');
        const showFriendRequestsButton = document.getElementById('show-friend-requests-button');
        const friendRequestBadge = document.getElementById('friend-request-badge'); // New badge for friend requests

        const chatHeader = document.getElementById('chat-header');
        const currentChatPic = document.getElementById('current-chat-pic');
        const currentChatName = document.getElementById('current-chat-name');
        const currentChatStatus = document.getElementById('current-chat-status');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const messageInputArea = document.getElementById('message-input-area');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const noChatSelected = document.getElementById('no-chat-selected');

        const contactsListView = document.getElementById('contacts-list-view');
        const contactsList = document.getElementById('contacts-list');
        const noContactsMessage = document.getElementById('no-contacts-message');
        const groupsListView = document.getElementById('groups-list-view');
        const groupsList = document.getElementById('groups-list');
        const noGroupsMessage = document.getElementById('no-groups-message');
        const friendRequestsListView = document.getElementById('friend-requests-list-view'); // New element
        const friendRequestsList = document.getElementById('friend-requests-list'); // New element
        const noFriendRequestsMessage = document.getElementById('no-friend-requests-message'); // New element

        const addContactButton = document.getElementById('add-contact-button');
        const addContactModal = document.getElementById('add-contact-modal');
        const cancelAddContactButton = document.getElementById('cancel-add-contact');
        const addContactForm = document.getElementById('add-contact-form');
        const contactInput = document.getElementById('contact-input');
        const addContactMessage = document.getElementById('add-contact-message');

        const createGroupButton = document.getElementById('create-group-button');
        const createGroupModal = document.getElementById('create-group-modal');
        const cancelCreateGroupButton = document.getElementById('cancel-create-group');
        const createGroupForm = document.getElementById('create-group-form');
        const groupNameInput = document.getElementById('group-name');
        const groupDescriptionInput = document.getElementById('group-description');
        const groupPhotoUploadInput = document.getElementById('group-photo-upload');
        const uploadGroupPicButton = document.getElementById('upload-group-pic-button');
        const groupPhotoPreview = document.getElementById('group-photo-preview');
        const groupMemberSelection = document.getElementById('group-member-selection');
        const noContactsForGroupMessage = document.getElementById('no-contacts-for-group');
        const createGroupMessage = document.getElementById('create-group-message');

        const addGroupMemberButton = document.getElementById('add-group-member-button');
        const addGroupMemberModal = document.getElementById('add-group-member-modal');
        const cancelAddGroupMemberButton = document.getElementById('cancel-add-group-member');
        const addGroupMemberForm = document.getElementById('add-group-member-form');
        const addGroupMemberInput = document.getElementById('add-group-member-input');
        const addGroupMemberMessage = document.getElementById('add-group-member-message');
        const leaveGroupButton = document.getElementById('leave-group-button');

        const attachMediaButton = document.getElementById('attach-media-button');
        const chatMediaUploadInput = document.getElementById('chat-media-upload');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalContent = document.getElementById('confirm-modal-content');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalOk = document.getElementById('confirm-modal-ok');

        const messageBox = document.getElementById('message-box');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxOk = document.getElementById('message-box-ok');

        const emailSentModal = document.getElementById('email-sent-modal');
        const emailSentOk = document.getElementById('email-sent-ok');

        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const cancelForgotPassword = document.getElementById('cancel-forgot-password');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const forgotEmailInput = document.getElementById('forgot-email');
        const forgotPasswordMessage = document.getElementById('forgot-password-message');

        const notificationsModal = document.getElementById('notifications-modal');
        const notificationsList = document.getElementById('notifications-list');
        const noNotificationsMessage = document.getElementById('no-notifications-message');
        const clearNotificationsButton = document.getElementById('clear-notifications-button');
        const closeNotificationsModal = document.getElementById('close-notifications-modal');


        // --- Utility Functions ---

        function showMessageBox(title, content, type = 'info') {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            // Optionally change color based on type (info, success, error)
            messageBoxTitle.className = 'text-xl font-bold mb-4 ' + (type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-800');
            messageBoxOk.className = 'px-6 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 ' + (type === 'error' ? 'bg-red-500 hover:bg-red-700 focus:ring-red-500' : type === 'success' ? 'bg-green-500 hover:bg-green-700 focus:ring-green-500' : 'bg-custom-secondary-blue hover:bg-custom-secondary-blue-dark focus:ring-custom-secondary-blue');
            messageBox.classList.remove('hidden');
        }

        messageBoxOk.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });


        function addNotification(title, message, type = 'info') {
            const id = notificationIdCounter++;
            const timestamp = new Date().toLocaleString();
            notifications.unshift({ id, title, message, type, timestamp });
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.length; // Assuming all are 'new' until dismissed or modal closed
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }
        }

        function displayNotifications() {
            notificationsList.innerHTML = '';
            if (notifications.length === 0) {
                noNotificationsMessage.classList.remove('hidden');
                notificationsList.classList.add('hidden');
            } else {
                noNotificationsMessage.classList.add('hidden'); // Ensure this is hidden if there are notifications
                notificationsList.classList.remove('hidden');
                notifications.forEach(notification => {
                    const li = document.createElement('li');
                    li.className = `p-3 rounded-md shadow-sm border-l-4 ${notification.type === 'error' ? 'bg-red-50 border-red-500' : notification.type === 'success' ? 'bg-green-50 border-green-500' : 'bg-blue-50 border-custom-secondary-blue'}`;
                    li.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-semibold text-gray-800">${notification.title}</h4>
                            <span class="text-xs text-gray-500">${notification.timestamp}</span>
                        </div>
                        <p class="text-sm text-gray-700">${notification.message}</p>
                    `;
                    notificationsList.appendChild(li);
                });
            }
            notificationsModal.classList.remove('hidden');
        }

        clearNotificationsButton.addEventListener('click', () => {
            notifications = [];
            updateNotificationBadge();
            displayNotifications(); // Re-render to show no notifications message
            addNotification('Notificaciones Borradas', 'Todas las notificaciones han sido eliminadas.', 'info');
        });

        closeNotificationsModal.addEventListener('click', () => {
            notificationsModal.classList.add('hidden');
        });

        // --- Cloudinary Upload Function ---
        async function uploadImageToCloudinary(file) {
            if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
                console.error("Cloudinary configuration missing:", { CLOUDINARY_CLOUD_NAME, CLOUDINARY_UPLOAD_PRESET });
                throw new Error("Cloudinary configuration missing. Please set CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET.");
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
            console.log("Attempting Cloudinary upload to:", uploadUrl);
            console.log("Using upload preset:", CLOUDINARY_UPLOAD_PRESET);
            console.log("File name:", file.name, "File type:", file.type, "File size:", file.size);


            try {
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Cloudinary API response error:", errorData);
                    if (errorData.error && errorData.error.message === "Unknown API key ") {
                        throw new Error(`Cloudinary upload failed: Unknown API key. Please check your Cloudinary Cloud Name and ensure your Upload Preset '${CLOUDINARY_UPLOAD_PRESET}' is correctly configured and active in your Cloudinary dashboard.`);
                    }
                    throw new Error(`Cloudinary upload failed: ${errorData.error ? errorData.error.message : response.statusText}`);
                }

                const data = await response.json();
                console.log("Cloudinary upload successful:", data);
                return data.secure_url; // Return the secure URL of the uploaded image
            } catch (error) {
                console.error("Error uploading to Cloudinary:", error);
                throw error; // Re-throw to be caught by the calling function
            }
        }


        // --- Auth State Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if Firebase services were successfully initialized
            if (!auth || !db) { // Removed storage check
                console.error("Firebase services failed to initialize. Auth state listener will not run.");
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email;

                    // Load user data from Firestore
                    const userDocRef = doc(db, "users", currentUserId);
                    const userDocSnap = await getDoc(userDocRef);

                    if (!userDocSnap.exists()) {
                        // New user, create document with initial data
                        await setDoc(userDocRef, {
                            email: user.email,
                            username: user.email.split('@')[0], // Default username
                            profilePicUrl: userProfilePicUrl,
                            phone: '',
                            dob: '',
                            age: null,
                            emailVerified: user.emailVerified,
                            contacts: [], // Initialize empty contacts array
                            friendRequestsSent: [], // Initialize empty sent requests array
                            friendRequestsReceived: [], // Initialize empty received requests array
                            createdAt: serverTimestamp()
                        });
                        userDisplayName = user.email.split('@')[0];
                        addNotification('Bienvenido', `Tu cuenta ha sido creada. ¡Empieza a chatear!`, 'success');
                    } else {
                        const userData = userDocSnap.data();
                        userDisplayName = userData.username || user.email.split('@')[0];
                        userProfilePicUrl = userData.profilePicUrl || userProfilePicUrl;
                        userPhoneDisplay.textContent = userData.phone || 'N/A';
                        userDobDisplay.textContent = userData.dob || 'N/A';
                        userAgeDisplay.textContent = userData.age ? `${userData.age} años` : 'N/A';
                    }

                    userDisplayUsernameElement.textContent = userDisplayName;
                    profilePicElement.src = userProfilePicUrl;

                    // Update email verification status
                    updateEmailVerificationStatus(user);

                    authSection.classList.add('hidden');
                    appSection.classList.remove('hidden');
                    // Ensure sidebar is visible on desktop, hidden on mobile initially
                    sidebar.classList.remove('-translate-x-full'); // Remove mobile hidden class
                    sidebar.classList.add('md:translate-x-0'); // Add desktop visible class
                    sidebarOverlay.classList.add('hidden'); // Hide overlay

                    // Start listening for contacts and friend requests
                    if (unsubscribeContacts) unsubscribeContacts(); // Unsubscribe previous listener if exists
                    listenForContacts(currentUserId);
                    if (unsubscribeFriendRequests) unsubscribeFriendRequests(); // Unsubscribe previous listener if exists
                    listenForFriendRequests(currentUserId);

                    // Start listening for groups
                    if (unsubscribeGroups) unsubscribeGroups();
                    listenForGroups(currentUserId);

                    // Show contacts list by default
                    showView('contacts-list-view');

                } else {
                    currentUserId = null;
                    currentUserEmail = null;
                    userDisplayName = null;
                    activeChat = null;
                    contacts = [];
                    groups = [];
                    friendRequests = [];
                    if (unsubscribeMessages) unsubscribeMessages();
                    if (unsubscribeContacts) unsubscribeContacts();
                    if (unsubscribeGroups) unsubscribeGroups();
                    if (unsubscribeFriendRequests) unsubscribeFriendRequests();
                    authSection.classList.remove('hidden');
                    appSection.classList.add('hidden');
                    // Reset auth form to login view on logout
                    showLoginView();
                }
            });

            // Apply saved theme on load
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                if (themeToggleButton) themeToggleButton.innerHTML = `<i class="fas fa-moon mr-2"></i>Cambiar Tema`;
            } else {
                if (themeToggleButton) themeToggleButton.innerHTML = `<i class="fas fa-sun mr-2"></i>Cambiar Tema`;
            }
        });

        // --- Auth Forms & Logic ---
        let isLogin = true;

        function showLoginView() {
            authTitle.textContent = 'Iniciar Sesión';
            authButton.textContent = 'Iniciar Sesión';
            toggleAuthButton.textContent = 'Regístrate';
            registerFields.classList.add('hidden');
            authMessage.textContent = '';
            isLogin = true;
        }

        function showRegisterView() {
            authTitle.textContent = 'Registrarse';
            authButton.textContent = 'Registrarse';
            toggleAuthButton.textContent = 'Iniciar Sesión';
            registerFields.classList.remove('hidden');
            authMessage.textContent = '';
            isLogin = false;
        }

        toggleAuthButton.addEventListener('click', () => {
            if (isLogin) {
                showRegisterView();
            } else {
                showLoginView();
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            authMessage.textContent = '';

            if (isLogin) {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    addNotification('Inicio de Sesión Exitoso', `Bienvenido de nuevo, ${auth.currentUser.displayName || auth.currentUser.email}.`, 'success');
                } catch (error) {
                    console.error("Error al iniciar sesión:", error);
                    let errorMessage = "Error al iniciar sesión. Por favor, verifica tus credenciales.";
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "No hay usuario con ese correo electrónico.";
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = "Contraseña incorrecta.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Correo electrónico no válido.";
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = "Demasiados intentos fallidos. Inténtalo de nuevo más tarde.";
                    }
                    authMessage.textContent = errorMessage;
                    addNotification('Error de Autenticación', errorMessage, 'error');
                }
            } else {
                const username = usernameInput.value || email.split('@')[0];
                const phone = phoneInput.value;
                const dob = dobInput.value;
                const age = ageInput.value ? parseInt(ageInput.value) : null;

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    await setDoc(doc(db, "users", user.uid), {
                        email: user.email,
                        username: username,
                        profilePicUrl: userProfilePicUrl, // Default profile picture
                        phone: phone,
                        dob: dob,
                        age: age,
                        emailVerified: user.emailVerified,
                        contacts: [], // Important: initialize as empty array
                        friendRequestsSent: [],
                        friendRequestsReceived: [],
                        createdAt: serverTimestamp()
                    });

                    // Update Auth profile
                    await updateProfile(user, {
                        displayName: username,
                        photoURL: userProfilePicUrl
                    });

                    // Send verification email
                    await sendEmailVerification(user);
                    emailSentModal.classList.remove('hidden');
                    addNotification('Registro Exitoso', `Cuenta creada para ${username}. Por favor, verifica tu correo electrónico.`, 'success');

                } catch (error) {
                    console.error("Error al registrarse:", error);
                    let errorMessage = "Error al registrarse.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "Este correo electrónico ya está en uso. Por favor, inicia sesión o usa otro correo.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "La contraseña es demasiado débil (mínimo 6 caracteres).";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Correo electrónico no válido.";
                    }
                    authMessage.textContent = errorMessage;
                    addNotification('Error de Registro', errorMessage, 'error');
                }
            }
        });

        emailSentOk.addEventListener('click', () => {
            emailSentModal.classList.add('hidden');
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                addNotification('Sesión Cerrada', 'Has cerrado sesión correctamente.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                addNotification('Error al Cerrar Sesión', 'No se pudo cerrar sesión. Inténtalo de nuevo.', 'error');
            }
        });

        mobileLogoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                addNotification('Sesión Cerrada', 'Has cerrado sesión correctamente.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                addNotification('Error al Cerrar Sesión', 'No se pudo cerrar sesión. Inténtalo de nuevo.', 'error');
            }
        });


        // --- Profile Management ---
        uploadPicButton.addEventListener('click', () => {
            profilePicUploadInput.click();
        });

        profilePicUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                addNotification('Error de Subida', 'El archivo es demasiado grande (máximo 5MB).', 'error');
                return;
            }

            try {
                const photoURL = await uploadImageToCloudinary(file);

                await updateDoc(doc(db, "users", currentUserId), {
                    profilePicUrl: photoURL
                });

                await updateProfile(auth.currentUser, {
                    photoURL: photoURL
                });

                profilePicElement.src = photoURL;
                addNotification('Foto Actualizada', 'Tu foto de perfil ha sido actualizada.', 'success');
            } catch (error) {
                console.error("Error al subir foto de perfil:", error);
                addNotification('Error de Subida', 'Hubo un error al subir la foto de perfil.', 'error');
            }
        });

        changeUsernameButton.addEventListener('click', () => {
            newUsernameInput.value = userDisplayName;
            changeUsernameMessage.textContent = '';
            changeUsernameModal.classList.remove('hidden');
        });

        cancelChangeUsernameButton.addEventListener('click', () => {
            changeUsernameModal.classList.add('hidden');
        });

        changeUsernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = newUsernameInput.value.trim();
            if (!newUsername) {
                changeUsernameMessage.textContent = 'El nombre de usuario no puede estar vacío.';
                return;
            }

            if (newUsername === userDisplayName) {
                changeUsernameMessage.textContent = 'El nuevo nombre de usuario es el mismo que el actual.';
                return;
            }

            try {
                // Check if username already exists
                const q = query(collection(db, "users"), where("username", "==", newUsername));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty && querySnapshot.docs[0].id !== currentUserId) {
                    changeUsernameMessage.textContent = 'Este nombre de usuario ya está en uso. Por favor, elige otro.';
                    addNotification('Error al Cambiar Nombre de Usuario', 'Este nombre de usuario ya está en uso.', 'error');
                    return;
                }

                const userDocRef = doc(db, "users", currentUserId);
                await updateDoc(userDocRef, {
                    username: newUsername
                });

                // Update auth profile
                await updateProfile(auth.currentUser, {
                    displayName: newUsername
                });

                userDisplayName = newUsername;
                userDisplayUsernameElement.textContent = newUsername;
                addNotification('Nombre de Usuario Actualizado', `Tu nombre de usuario se ha cambiado a "${newUsername}" correctamente.`, 'success');
                changeUsernameModal.classList.add('hidden');
            } catch (error) {
                console.error('Error al cambiar nombre de usuario:', error);
                let errorMessage = `Hubo un problema al cambiar el nombre de usuario.`;
                if (error.code === 'permission-denied' || (error.message && error.message.includes('Missing or insufficient permissions'))) {
                    errorMessage = 'No tienes permisos suficientes para cambiar el nombre de usuario. Asegúrate de que las reglas de seguridad de Firestore estén configuradas correctamente.';
                }
                changeUsernameMessage.textContent = errorMessage;
                addNotification('Error al Cambiar Nombre de Usuario', errorMessage, 'error');
            }
        });

        // --- Email Verification ---
        function updateEmailVerificationStatus(user) {
            if (user.emailVerified) {
                emailVerifiedText.textContent = 'Email Verificado';
                emailVerifiedText.className = 'text-xs text-green-600';
                resendVerificationEmailSidebar.classList.add('hidden');
                if (resendEmailTimer) clearInterval(resendEmailTimer);
            } else {
                emailVerifiedText.textContent = 'Email No Verificado';
                emailVerifiedText.className = 'text-xs text-red-600';
                resendVerificationEmailSidebar.classList.remove('hidden');
                startResendEmailCooldown();
            }
        }

        let cooldownRemaining = 0;
        function startResendEmailCooldown() {
            cooldownRemaining = resendEmailCooldown;
            resendVerificationEmailSidebar.disabled = true;
            resendVerificationEmailSidebar.textContent = `Reenviar Email (${cooldownRemaining}s)`;

            resendEmailTimer = setInterval(() => {
                cooldownRemaining--;
                if (cooldownRemaining <= 0) {
                    clearInterval(resendEmailTimer);
                    resendVerificationEmailSidebar.disabled = false;
                    resendVerificationEmailSidebar.textContent = 'Reenviar Email de Verificación';
                } else {
                    resendVerificationEmailSidebar.textContent = `Reenviar Email (${cooldownRemaining}s)`;
                }
            }, 1000);
        }

        resendVerificationEmailSidebar.addEventListener('click', async () => {
            try {
                if (auth.currentUser && !auth.currentUser.emailVerified) {
                    await sendEmailVerification(auth.currentUser);
                    addNotification('Email Enviado', 'Enlace de verificación reenviado. Revisa tu bandeja de entrada.', 'info');
                    startResendEmailCooldown();
                }
            } catch (error) {
                console.error("Error al reenviar email de verificación:", error);
                let errorMessage = `No se pudo reenviar el email de verificación. Por favor, inténtalo de nuevo más tarde.`;
                if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Has solicitado demasiados emails de verificación. Por favor, espera un momento antes de intentarlo de nuevo.';
                }
                addNotification('Error al Reenviar Email', errorMessage, 'error');
                // Even on error, keep the cooldown to prevent rapid retries
            }
        });

        // --- Forgot Password Logic ---
        forgotPasswordLink.addEventListener('click', () => {
            forgotPasswordMessage.textContent = '';
            forgotEmailInput.value = '';
            forgotPasswordModal.classList.remove('hidden');
        });

        cancelForgotPassword.addEventListener('click', () => {
            forgotPasswordModal.classList.add('hidden');
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = forgotEmailInput.value;
            forgotPasswordMessage.textContent = '';

            try {
                await sendPasswordResetEmail(auth, email);
                forgotPasswordMessage.textContent = 'Se ha enviado un enlace para restablecer la contraseña a tu correo electrónico.';
                forgotPasswordMessage.className = 'text-sm text-green-600';
                addNotification('Restablecer Contraseña', 'Enlace enviado a tu correo electrónico.', 'success');
                setTimeout(() => forgotPasswordModal.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Error al restablecer contraseña:", error);
                let errorMessage = "Error al enviar el enlace de restablecimiento de contraseña.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No hay usuario registrado con ese correo electrónico.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Correo electrónico no válido.";
                }
                forgotPasswordMessage.textContent = errorMessage;
                forgotPasswordMessage.className = 'text-sm text-red-600';
                addNotification('Error de Restablecimiento', errorMessage, 'error');
            }
        });


        // --- Sidebar Toggles ---
        mobileSidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        });

        closeSidebarButton.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });


        // --- View Management ---
        function hideAllViews() {
            contactsListView.classList.add('hidden');
            groupsListView.classList.add('hidden');
            chatMessagesContainer.classList.add('hidden');
            messageInputArea.classList.add('hidden');
            noChatSelected.classList.add('hidden');
            friendRequestsListView.classList.add('hidden'); // Hide new view
        }

        function showView(viewId) {
            hideAllViews();
            document.getElementById(viewId).classList.remove('hidden');
            // Hide specific elements if a chat is not selected
            if (viewId !== 'chat-messages-container') {
                chatHeader.classList.remove('hidden'); // Ensure header is visible
                currentChatName.textContent = 'Selecciona un chat';
                currentChatStatus.textContent = '';
                currentChatPic.src = "https://placehold.co/50x50/E2E8F0/4A5568?text=Chat";
                addGroupMemberButton.classList.add('hidden');
                leaveGroupButton.classList.add('hidden');
                activeChat = null;
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                    unsubscribeMessages = null;
                }
            }
            // Close sidebar on mobile after view selection
            if (window.innerWidth < 768) { // Only close on mobile breakpoints
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        }

        showContactsButton.addEventListener('click', () => showView('contacts-list-view'));
        showGroupsButton.addEventListener('click', () => showView('groups-list-view'));
        showNotificationsButton.addEventListener('click', () => {
            showView('contacts-list-view'); // Default to contacts view when showing notifications modal
            displayNotifications();
        });
        showFriendRequestsButton.addEventListener('click', () => showView('friend-requests-list-view')); // New event listener


        // --- Chat Functions ---
        async function loadMessages(chatType, chatId) {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Detach previous listener
            }

            chatMessagesContainer.innerHTML = ''; // Clear previous messages
            noChatSelected.classList.add('hidden');
            chatMessagesContainer.classList.remove('hidden');
            messageInputArea.classList.remove('hidden');

            const messagesRef = collection(db, "messages");
            let q;

            if (chatType === 'contact') {
                // For direct messages, query messages where senderId and receiverId match either way
                q = query(messagesRef,
                    where("type", "==", "private"),
                    where("participants", "array-contains-any", [currentUserId, chatId]),
                    orderBy("timestamp", "asc")
                );
            } else if (chatType === 'group') {
                q = query(messagesRef,
                    where("type", "==", "group"),
                    where("groupId", "==", chatId),
                    orderBy("timestamp", "asc")
                );
            } else {
                console.error("Tipo de chat no válido:", chatType);
                return;
            }

            unsubscribeMessages = onSnapshot(q, async (snapshot) => {
                chatMessagesContainer.innerHTML = ''; // Clear messages before re-rendering
                const messages = [];
                for (const docSnapshot of snapshot.docs) {
                    const messageData = docSnapshot.data();
                    let senderInfo = { username: "Desconocido", profilePicUrl: "https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF" };
                    if (messageData.senderId) {
                        senderInfo = await getUserInfo(messageData.senderId);
                    }
                    messages.push({ id: docSnapshot.id, ...messageData, senderInfo });
                }
                displayMessages(messages);
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
            }, (error) => {
                console.error("Error al escuchar mensajes:", error);
                addNotification('Error de Chat', 'No se pudieron cargar los mensajes.', 'error');
            });
        }

        const userInfoCache = {}; // Cache for user info

        async function getUserInfo(uid) {
            if (userInfoCache[uid]) {
                return userInfoCache[uid];
            }
            try {
                const userDocRef = doc(db, "users", uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const info = {
                        username: userData.username || userData.email.split('@')[0],
                        profilePicUrl: userData.profilePicUrl || "https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF"
                    };
                    userInfoCache[uid] = info; // Cache the result
                    return info;
                }
            } catch (error) {
                console.error("Error getting user info:", error);
            }
            return null; // User not found or error
        }

        function displayMessages(messages) {
            messages.forEach(message => {
                const isSelf = message.senderId === currentUserId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-container ${isSelf ? 'self' : 'other'}`;

                let mediaContent = '';
                if (message.mediaUrl) {
                    if (message.mediaType && message.mediaType.startsWith('image/')) {
                        mediaContent = `<img src="${message.mediaUrl}" alt="Imagen enviada" class="max-w-xs rounded-lg object-cover mt-2">`;
                    } else if (message.mediaType && message.mediaType.startsWith('video/')) {
                        mediaContent = `<video controls src="${message.mediaUrl}" class="max-w-xs rounded-lg object-cover mt-2"></video>`;
                    }
                }

                messageDiv.innerHTML = `
                    <img src="${message.senderInfo.profilePicUrl}" alt="${message.senderInfo.username}" class="message-avatar">
                    <div class="message-bubble ${isSelf ? 'self' : 'other'}">
                        <div class="message-sender">${isSelf ? 'Tú' : message.senderInfo.username}</div>
                        <div class="message-content">${message.text || ''}</div>
                        ${mediaContent}
                        <div class="message-timestamp">${new Date(message.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                `;
                chatMessagesContainer.appendChild(messageDiv);
            });
        }

        sendMessageButton.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            const mediaFile = chatMediaUploadInput.files[0];

            if (!activeChat) {
                showMessageBox('Error', 'Por favor, selecciona un chat para enviar un mensaje.');
                return;
            }

            if (!messageText && !mediaFile) {
                showMessageBox('Advertencia', 'No puedes enviar un mensaje vacío.');
                return;
            }

            let mediaUrl = null;
            let mediaType = null;

            if (mediaFile) {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit for media
                    addNotification('Error de Subida', 'El archivo multimedia es demasiado grande (máximo 10MB).', 'error');
                    return;
                }
                try {
                    mediaUrl = await uploadImageToCloudinary(mediaFile); // Use the same function for images/videos
                    mediaType = mediaFile.type;
                } catch (error) {
                    console.error("Error al subir archivo multimedia:", error);
                    addNotification('Error de Subida', 'Hubo un error al subir el archivo multimedia.', 'error');
                    return;
                }
            }

            const messageData = {
                senderId: currentUserId,
                text: messageText,
                timestamp: serverTimestamp(),
                mediaUrl: mediaUrl,
                mediaType: mediaType
            };

            if (activeChat.type === 'contact') {
                messageData.type = 'private';
                messageData.receiverId = activeChat.id;
                messageData.participants = [currentUserId, activeChat.id]; // Store participants for easy querying
            } else if (activeChat.type === 'group') {
                messageData.type = 'group';
                messageData.groupId = activeChat.id;
            }

            try {
                await addDoc(collection(db, "messages"), messageData);
                messageInput.value = ''; // Clear input
                chatMediaUploadInput.value = ''; // Clear file input
                addNotification('Mensaje Enviado', 'Tu mensaje ha sido enviado.', 'success');
            } catch (error) {
                console.error("Error al enviar mensaje:", error);
                addNotification('Error de Envío', 'No se pudo enviar el mensaje.', 'error');
            }
        });

        // Event listener for attaching media
        attachMediaButton.addEventListener('click', () => {
            chatMediaUploadInput.click();
        });

        // Display selected file name next to input (optional, for user feedback)
        chatMediaUploadInput.addEventListener('change', () => {
            if (chatMediaUploadInput.files.length > 0) {
                // You might want to display the file name somewhere, e.g., next to the input field
                // For now, just a console log
                console.log("Archivo seleccionado:", chatMediaUploadInput.files[0].name);
                addNotification('Archivo Seleccionado', `Archivo: ${chatMediaUploadInput.files[0].name}`, 'info');
            }
        });


        // --- Contacts Management ---
        async function listenForContacts(userId) {
            const userDocRef = doc(db, "users", userId);
            unsubscribeContacts = onSnapshot(userDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const contactIds = userData.contacts || [];
                    const friendRequestsReceivedIds = (userData.friendRequestsReceived || []).map(req => req.senderId);

                    const updatedContacts = [];
                    for (const contactId of contactIds) {
                        const contactInfo = await getUserInfo(contactId);
                        if (contactInfo) {
                            updatedContacts.push({ id: contactId, ...contactInfo });
                        }
                    }
                    contacts = updatedContacts;
                    displayContacts();
                }
            }, (error) => {
                console.error("Error al escuchar contactos:", error);
                addNotification('Error de Contactos', 'No se pudieron cargar tus contactos.', 'error');
            });
        }

        function displayContacts() {
            contactsList.innerHTML = '';
            if (contacts.length === 0) {
                noContactsMessage.classList.remove('hidden');
            } else {
                noContactsMessage.classList.add('hidden');
                contacts.forEach(contact => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center p-3 rounded-lg hover:bg-gray-200 cursor-pointer transition-colors duration-200';
                    li.innerHTML = `
                        <img src="${contact.profilePicUrl}" alt="${contact.username}" class="w-10 h-10 rounded-full object-cover mr-3">
                        <span class="font-medium text-gray-800">${contact.username}</span>
                    `;
                    li.addEventListener('click', () => selectChat('contact', contact.id, contact.username, contact.profilePicUrl));
                    contactsList.appendChild(li);
                });
            }
            // Update group member selection list
            updateGroupMemberSelection();
        }

        addContactButton.addEventListener('click', () => {
            contactInput.value = '';
            addContactMessage.textContent = '';
            addContactModal.classList.remove('hidden');
        });

        cancelAddContactButton.addEventListener('click', () => {
            addContactModal.classList.add('hidden');
        });

        addContactForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = contactInput.value.trim();
            addContactMessage.textContent = '';

            if (!identifier) {
                addContactMessage.textContent = 'Por favor, introduce un correo electrónico o nombre de usuario.';
                return;
            }

            if (identifier === currentUserEmail || identifier === userDisplayName) {
                addContactMessage.textContent = 'No puedes enviarte una solicitud de amistad a ti mismo.';
                addNotification('Error de Solicitud', 'No puedes añadirte a ti mismo.', 'error');
                return;
            }

            try {
                // Find the target user by email or username
                let targetUserDoc;
                const qByEmail = query(collection(db, "users"), where("email", "==", identifier));
                const qByUsername = query(collection(db, "users"), where("username", "==", identifier));

                const [emailSnapshot, usernameSnapshot] = await Promise.all([getDocs(qByEmail), getDocs(qByUsername)]);

                if (!emailSnapshot.empty) {
                    targetUserDoc = emailSnapshot.docs[0];
                } else if (!usernameSnapshot.empty) {
                    targetUserDoc = usernameSnapshot.docs[0];
                } else {
                    addContactMessage.textContent = 'Usuario no encontrado. Verifica el correo o nombre de usuario.';
                    addNotification('Error de Solicitud', 'Usuario no encontrado.', 'error');
                    return;
                }

                const targetUserId = targetUserDoc.id;
                const targetUserData = targetUserDoc.data();

                // Check if already a contact
                if (contacts.some(c => c.id === targetUserId)) {
                    addContactMessage.textContent = 'Este usuario ya es tu contacto.';
                    addNotification('Error de Solicitud', 'Ya es tu contacto.', 'error');
                    return;
                }

                // Check if a request is already pending (sent by current user)
                const currentUserDoc = await getDoc(doc(db, "users", currentUserId));
                const currentUserData = currentUserDoc.data();
                if (currentUserData.friendRequestsSent && currentUserData.friendRequestsSent.some(req => req.receiverId === targetUserId)) {
                    addContactMessage.textContent = 'Ya has enviado una solicitud a este usuario.';
                    addNotification('Error de Solicitud', 'Solicitud ya enviada.', 'error');
                    return;
                }

                // Check if a request is already pending (received by current user from target)
                if (friendRequests.some(req => req.senderId === targetUserId)) {
                    addContactMessage.textContent = 'Este usuario ya te ha enviado una solicitud. Puedes aceptarla.';
                    addNotification('Error de Solicitud', 'Solicitud pendiente de aceptación.', 'info');
                    return;
                }

                // Add to sender's friendRequestsSent
                await updateDoc(doc(db, "users", currentUserId), {
                    friendRequestsSent: arrayUnion({ receiverId: targetUserId, timestamp: serverTimestamp() })
                });

                // Add to receiver's friendRequestsReceived
                await updateDoc(doc(db, "users", targetUserId), {
                    friendRequestsReceived: arrayUnion({ senderId: currentUserId, timestamp: serverTimestamp() })
                });

                addContactMessage.textContent = `Solicitud de amistad enviada a ${targetUserData.username || targetUserData.email}.`;
                addContactMessage.className = 'text-sm text-green-600';
                addNotification('Solicitud Enviada', `Solicitud enviada a ${targetUserData.username || targetUserData.email}.`, 'success');
                setTimeout(() => addContactModal.classList.add('hidden'), 2000);

            } catch (error) {
                console.error("Error al enviar solicitud de amistad:", error);
                addContactMessage.textContent = 'Hubo un error al enviar la solicitud de amistad.';
                addNotification('Error de Solicitud', 'No se pudo enviar la solicitud.', 'error');
            }
        });


        // --- Friend Request Management ---
        async function listenForFriendRequests(userId) {
            const userDocRef = doc(db, "users", userId);
            unsubscribeFriendRequests = onSnapshot(userDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const receivedRequests = userData.friendRequestsReceived || [];

                    const updatedRequests = [];
                    for (const req of receivedRequests) {
                        const senderInfo = await getUserInfo(req.senderId);
                        if (senderInfo) {
                            updatedRequests.push({ senderId: req.senderId, timestamp: req.timestamp, ...senderInfo });
                        }
                    }
                    friendRequests = updatedRequests;
                    displayFriendRequests();
                    updateFriendRequestBadge();
                }
            }, (error) => {
                console.error("Error al escuchar solicitudes de amistad:", error);
                addNotification('Error de Solicitudes', 'No se pudieron cargar las solicitudes de amistad.', 'error');
            });
        }

        function displayFriendRequests() {
            friendRequestsList.innerHTML = '';
            if (friendRequests.length === 0) {
                noFriendRequestsMessage.classList.remove('hidden');
            } else {
                noFriendRequestsMessage.classList.add('hidden');
                friendRequests.forEach(request => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-3 rounded-lg bg-gray-50 border border-gray-200 shadow-sm mb-2';
                    li.innerHTML = `
                        <div class="flex items-center">
                            <img src="${request.profilePicUrl}" alt="${request.username}" class="w-10 h-10 rounded-full object-cover mr-3">
                            <div>
                                <span class="font-medium text-gray-800">${request.username}</span>
                                <p class="text-sm text-gray-500">Solicitud de amistad</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button data-sender-id="${request.senderId}" class="accept-request-button px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm">Aceptar</button>
                            <button data-sender-id="${request.senderId}" class="reject-request-button px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors text-sm">Rechazar</button>
                        </div>
                    `;
                    friendRequestsList.appendChild(li);
                });

                // Add event listeners to new buttons
                document.querySelectorAll('.accept-request-button').forEach(button => {
                    button.addEventListener('click', (e) => acceptFriendRequest(e.target.dataset.senderId));
                });
                document.querySelectorAll('.reject-request-button').forEach(button => {
                    button.addEventListener('click', (e) => rejectFriendRequest(e.target.dataset.senderId));
                });
            }
        }

        function updateFriendRequestBadge() {
            const pendingRequestsCount = friendRequests.length;
            if (pendingRequestsCount > 0) {
                friendRequestBadge.textContent = pendingRequestsCount;
                friendRequestBadge.classList.remove('hidden');
            } else {
                friendRequestBadge.classList.add('hidden');
            }
        }

        async function acceptFriendRequest(senderId) {
            try {
                const currentUserRef = doc(db, "users", currentUserId);
                const senderUserRef = doc(db, "users", senderId);

                // 1. Add sender to current user's contacts
                await updateDoc(currentUserRef, {
                    contacts: arrayUnion(senderId),
                    friendRequestsReceived: arrayRemove({ senderId: senderId, timestamp: friendRequests.find(req => req.senderId === senderId).timestamp })
                });

                // 2. Add current user to sender's contacts
                await updateDoc(senderUserRef, {
                    contacts: arrayUnion(currentUserId),
                    friendRequestsSent: arrayRemove({ receiverId: currentUserId, timestamp: (await getDoc(senderUserRef)).data().friendRequestsSent.find(req => req.receiverId === currentUserId).timestamp })
                });

                addNotification('Solicitud Aceptada', `Has aceptado la solicitud de amistad de ${friendRequests.find(req => req.senderId === senderId).username}.`, 'success');
                // Re-listen for contacts and friend requests to update UI
                listenForContacts(currentUserId);
                listenForFriendRequests(currentUserId);
            } catch (error) {
                console.error("Error al aceptar solicitud de amistad:", error);
                addNotification('Error', 'No se pudo aceptar la solicitud de amistad.', 'error');
            }
        }

        async function rejectFriendRequest(senderId) {
            try {
                const currentUserRef = doc(db, "users", currentUserId);
                const senderUserRef = doc(db, "users", senderId);

                // 1. Remove from current user's received requests
                await updateDoc(currentUserRef, {
                    friendRequestsReceived: arrayRemove({ senderId: senderId, timestamp: friendRequests.find(req => req.senderId === senderId).timestamp })
                });

                // 2. Remove from sender's sent requests
                await updateDoc(senderUserRef, {
                    friendRequestsSent: arrayRemove({ receiverId: currentUserId, timestamp: (await getDoc(senderUserRef)).data().friendRequestsSent.find(req => req.receiverId === currentUserId).timestamp })
                });

                addNotification('Solicitud Rechazada', `Has rechazado la solicitud de amistad de ${friendRequests.find(req => req.senderId === senderId).username}.`, 'info');
                // Re-listen for friend requests to update UI
                listenForFriendRequests(currentUserId);
            } catch (error) {
                console.error("Error al rechazar solicitud de amistad:", error);
                addNotification('Error', 'No se pudo rechazar la solicitud de amistad.', 'error');
            }
        }


        // --- Group Management ---
        async function listenForGroups(userId) {
            const groupsRef = collection(db, "groups");
            // Query for groups where the current user is a member
            const q = query(groupsRef, where("members", "array-contains", userId));

            unsubscribeGroups = onSnapshot(q, async (snapshot) => {
                const updatedGroups = [];
                for (const docSnap of snapshot.docs) {
                    const groupData = docSnap.data();
                    // Fetch admin info
                    let adminInfo = { username: "Admin Desconocido", profilePicUrl: "https://placehold.co/100x100/A0AEC0/FFFFFF?text=PF" };
                    if (groupData.adminId) {
                        adminInfo = await getUserInfo(groupData.adminId);
                    }
                    updatedGroups.push({ id: docSnap.id, ...groupData, adminInfo });
                }
                groups = updatedGroups;
                displayGroups();
            }, (error) => {
                console.error("Error al escuchar grupos:", error);
                addNotification('Error de Grupos', 'No se pudieron cargar tus grupos.', 'error');
            });
        }

        function displayGroups() {
            groupsList.innerHTML = '';
            if (groups.length === 0) {
                noGroupsMessage.classList.remove('hidden');
            } else {
                noGroupsMessage.classList.add('hidden');
                groups.forEach(group => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center p-3 rounded-lg hover:bg-gray-200 cursor-pointer transition-colors duration-200';
                    li.innerHTML = `
                        <img src="${group.photoURL || 'https://placehold.co/80x80/E2E8F0/4A5568?text=Grupo'}" alt="${group.name}" class="w-10 h-10 rounded-full object-cover mr-3">
                        <div>
                            <span class="font-medium text-gray-800">${group.name}</span>
                            <p class="text-sm text-gray-500">${group.description || 'Sin descripción'}</p>
                        </div>
                    `;
                    li.addEventListener('click', () => selectChat('group', group.id, group.name, group.photoURL, group.adminId));
                    groupsList.appendChild(li);
                });
            }
        }

        createGroupButton.addEventListener('click', () => {
            groupNameInput.value = '';
            groupDescriptionInput.value = '';
            groupPhotoUploadInput.value = '';
            groupPhotoPreview.src = 'https://placehold.co/80x80/E2E8F0/4A5568?text=Grupo';
            createGroupMessage.textContent = '';
            updateGroupMemberSelection();
            createGroupModal.classList.remove('hidden');
        });

        cancelCreateGroupButton.addEventListener('click', () => {
            createGroupModal.classList.add('hidden');
        });

        uploadGroupPicButton.addEventListener('click', () => {
            groupPhotoUploadInput.click();
        });

        groupPhotoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    groupPhotoPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function updateGroupMemberSelection() {
            groupMemberSelection.innerHTML = '';
            if (contacts.length === 0) {
                noContactsForGroupMessage.classList.remove('hidden');
                groupMemberSelection.appendChild(noContactsForGroupMessage);
            } else {
                noContactsForGroupMessage.classList.add('hidden');
                contacts.forEach(contact => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2';
                    div.innerHTML = `
                        <input type="checkbox" id="member-${contact.id}" value="${contact.id}" class="form-checkbox h-4 w-4 text-custom-primary rounded focus:ring-custom-primary">
                        <label for="member-${contact.id}" class="text-sm text-gray-700">${contact.username}</label>
                    `;
                    groupMemberSelection.appendChild(div);
                });
            }
        }

        createGroupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = groupNameInput.value.trim();
            const groupDescription = groupDescriptionInput.value.trim();
            const selectedMembers = Array.from(groupMemberSelection.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

            if (!groupName) {
                createGroupMessage.textContent = 'El nombre del grupo es obligatorio.';
                return;
            }

            if (selectedMembers.length === 0) {
                createGroupMessage.textContent = 'Selecciona al menos un miembro para el grupo.';
                return;
            }

            // Add current user to selected members automatically
            if (!selectedMembers.includes(currentUserId)) {
                selectedMembers.push(currentUserId);
            }

            let groupPhotoURL = '';
            const file = groupPhotoUploadInput.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    addNotification('Error de Subida', 'La foto del grupo es demasiado grande (máximo 5MB).', 'error');
                    return;
                }
                try {
                    groupPhotoURL = await uploadImageToCloudinary(file);
                } catch (error) {
                    console.error("Error al subir foto de grupo:", error);
                    addNotification('Error de Subida', 'Hubo un error al subir la foto del grupo.', 'error');
                    return;
                }
            }

            try {
                const newGroupRef = await addDoc(collection(db, "groups"), {
                    name: groupName,
                    description: groupDescription,
                    photoURL: groupPhotoURL,
                    adminId: currentUserId,
                    members: selectedMembers,
                    createdAt: serverTimestamp()
                });

                // Update each member's user document to include this group in their 'groups' array
                for (const memberId of selectedMembers) {
                    await updateDoc(doc(db, "users", memberId), {
                        groups: arrayUnion(newGroupRef.id)
                    });
                }

                addNotification('Grupo Creado', `El grupo "${groupName}" ha sido creado.`, 'success');
                createGroupModal.classList.add('hidden');
                // Refresh groups list
                listenForGroups(currentUserId);
            } catch (error) {
                console.error("Error al crear grupo:", error);
                createGroupMessage.textContent = 'Hubo un error al crear el grupo.';
                addNotification('Error de Grupo', 'No se pudo crear el grupo.', 'error');
            }
        });

        // Add Group Member logic
        if (addGroupMemberButton) {
            addGroupMemberButton.addEventListener('click', () => {
                if (!activeChat || activeChat.type !== 'group') {
                    showMessageBox('Error', 'Debes seleccionar un grupo para añadir miembros.');
                    return;
                }
                if (activeChat.adminId !== currentUserId) {
                    showMessageBox('Permiso Denegado', 'Solo el administrador del grupo puede añadir miembros.');
                    return;
                }
                if (addGroupMemberModal) addGroupMemberModal.classList.remove('hidden');
                if (addGroupMemberMessage) addGroupMemberMessage.textContent = '';
                if (addGroupMemberInput) addGroupMemberInput.value = '';
            });
        }

        if (cancelAddGroupMemberButton) {
            cancelAddGroupMemberButton.addEventListener('click', () => {
                if (addGroupMemberModal) addGroupMemberModal.classList.add('hidden');
            });
        }

        if (addGroupMemberForm) {
            addGroupMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const memberIdentifier = addGroupMemberInput ? addGroupMemberInput.value.trim() : '';
                if (!memberIdentifier) {
                    if (addGroupMemberMessage) addGroupMemberMessage.textContent = 'Por favor, introduce el correo electrónico o nombre de usuario del miembro.';
                    return;
                }

                if (!activeChat || activeChat.type !== 'group') {
                    showMessageBox('Error', 'No hay un grupo activo para añadir miembros.');
                    return;
                }

                try {
                    // Find the target user by email or username
                    let targetUserDoc;
                    const qByEmail = query(collection(db, "users"), where("email", "==", memberIdentifier));
                    const qByUsername = query(collection(db, "users"), where("username", "==", memberIdentifier));

                    const [emailSnapshot, usernameSnapshot] = await Promise.all([getDocs(qByEmail), getDocs(qByUsername)]);

                    if (!emailSnapshot.empty) {
                        targetUserDoc = emailSnapshot.docs[0];
                    } else if (!usernameSnapshot.empty) {
                        targetUserDoc = usernameSnapshot.docs[0];
                    } else {
                        if (addGroupMemberMessage) addGroupMemberMessage.textContent = 'Usuario no encontrado. Verifica el correo o nombre de usuario.';
                        addNotification('Error al Añadir Miembro', 'Usuario no encontrado.', 'error');
                        return;
                    }

                    const targetUserId = targetUserDoc.id;
                    const targetUserData = targetUserDoc.data();

                    // Check if already a member
                    if (activeChat.members.includes(targetUserId)) {
                        if (addGroupMemberMessage) addGroupMemberMessage.textContent = 'Este usuario ya es miembro del grupo.';
                        addNotification('Error al Añadir Miembro', 'Ya es miembro del grupo.', 'error');
                        return;
                    }

                    // Add member to group's members array
                    const groupDocRef = doc(db, "groups", activeChat.id);
                    await updateDoc(groupDocRef, {
                        members: arrayUnion(targetUserId)
                    });

                    // Add group to member's groups array
                    const memberUserDocRef = doc(db, "users", targetUserId);
                    await updateDoc(memberUserDocRef, {
                        groups: arrayUnion(activeChat.id)
                    });

                    if (addGroupMemberMessage) {
                        addGroupMemberMessage.textContent = `"${targetUserData.username || targetUserData.email}" ha sido añadido al grupo.`;
                        addGroupMemberMessage.className = 'text-sm text-green-600';
                    }
                    addNotification('Miembro Añadido', `"${targetUserData.username || targetUserData.email}" ha sido añadido al grupo "${activeChat.name}".`, 'success');
                    setTimeout(() => {
                        if (addGroupMemberModal) addGroupMemberModal.classList.add('hidden');
                    }, 2000);

                    // Re-select chat to refresh member list in activeChat object
                    selectChat('group', activeChat.id, activeChat.name, activeChat.photoURL, activeChat.adminId);

                } catch (error) {
                    console.error("Error al añadir miembro al grupo:", error);
                    if (addGroupMemberMessage) addGroupMemberMessage.textContent = 'Hubo un error al añadir el miembro al grupo.';
                    addNotification('Error al Añadir Miembro', 'No se pudo añadir el miembro.', 'error');
                }
            });
        }

        async function leaveGroup() {
            if (!activeChat || activeChat.type !== 'group') {
                showMessageBox('Error', 'No hay un grupo activo para salir.');
                return;
            }

            showConfirmModal('Salir del Grupo', `¿Estás seguro de que quieres salir del grupo "${activeChat.name}"?`, async () => {
                try {
                    const groupDocRef = doc(db, "groups", activeChat.id);
                    const groupDocSnap = await getDoc(groupDocRef);

                    if (groupDocSnap.exists()) {
                        const groupData = groupDocSnap.data();
                        const currentMembers = groupData.members || [];

                        // If current user is the admin and is the only member, delete the group
                        if (activeChat.adminId === currentUserId && currentMembers.length === 1 && currentMembers.includes(currentUserId)) {
                            await deleteDoc(groupDocRef);
                            // Remove group from user's groups array
                            await updateDoc(doc(db, "users", currentUserId), {
                                groups: arrayRemove(activeChat.id)
                            });
                            addNotification('Grupo Eliminado', `El grupo "${activeChat.name}" ha sido eliminado ya que eras el último miembro.`, 'info');
                        } else {
                            // Remove current user from group's members array
                            await updateDoc(groupDocRef, {
                                members: arrayRemove(currentUserId)
                            });
                            // Remove group from user's groups array
                            await updateDoc(doc(db, "users", currentUserId), {
                                groups: arrayRemove(activeChat.id)
                            });
                            addNotification('Has Salido del Grupo', `Has salido del grupo "${activeChat.name}".`, 'info');

                            // If the admin leaves, assign a new admin if other members exist
                            if (activeChat.adminId === currentUserId && currentMembers.length > 1) {
                                const remainingMembers = currentMembers.filter(memberId => memberId !== currentUserId);
                                const newAdminId = remainingMembers[0]; // Assign first remaining member as new admin
                                await updateDoc(groupDocRef, {
                                    adminId: newAdminId
                                });
                                addNotification('Administrador de Grupo', `"${activeChat.name}" ahora tiene un nuevo administrador.`, 'info');
                            }
                        }
                    }

                    // Reset active chat and show groups list
                    activeChat = null;
                    showView('groups-list-view');
                    // Refresh groups list
                    listenForGroups(currentUserId);

                } catch (error) {
                    console.error("Error al salir del grupo:", error);
                    addNotification('Error al Salir del Grupo', 'No se pudo salir del grupo.', 'error');
                }
            });
        }

        if (leaveGroupButton) leaveGroupButton.addEventListener('click', leaveGroup);


        // --- Chat Selection ---
        async function selectChat(type, id, name, picUrl, adminId = null) {
            activeChat = { type, id, name, picUrl, adminId };

            currentChatName.textContent = name;
            currentChatPic.src = picUrl || (type === 'group' ? 'https://placehold.co/50x50/E2E8F0/4A5568?text=Grupo' : 'https://placehold.co/50x50/A0AEC0/FFFFFF?text=PF');
            currentChatStatus.textContent = type === 'contact' ? 'Online' : 'Grupo'; // Placeholder for status

            // Show/hide group management buttons
            if (type === 'group') {
                addGroupMemberButton.classList.remove('hidden');
                leaveGroupButton.classList.remove('hidden');
                // Optionally, hide add member button if not admin
                if (adminId !== currentUserId) {
                    addGroupMemberButton.classList.add('hidden');
                } else {
                    addGroupMemberButton.classList.remove('hidden');
                }
            } else {
                addGroupMemberButton.classList.add('hidden');
                leaveGroupButton.classList.add('hidden');
            }

            showView('chat-messages-container');
            await loadMessages(type, id);
        }

        // --- Confirmation Modal Logic ---
        let confirmCallback = null;

        function showConfirmModal(title, content, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalContent.textContent = content;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }

        confirmModalOk.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmModal.classList.add('hidden');
            confirmCallback = null; // Reset callback
        });

        confirmModalCancel.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null; // Reset callback
        });

    </script>
</body>
</html>
